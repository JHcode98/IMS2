<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - DMS</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="navbar">
      <div class="nav-left">
        <a href="index.html" class="nav-btn">Dashboard</a>
      </div>
      <div class="nav-title">User Profile</div>
      <div class="nav-right">
        <div class="nav-user" id="nav-user">
          <a href="profile.html" title="Profile" style="text-decoration:none; margin-right: 4px;"><span id="nav-avatar" class="avatar small"></span></a>
          <button id="user-btn" class="user-btn" aria-haspopup="true" aria-expanded="false">
            <span id="username-display"></span>
          </button>
          <div class="user-menu" id="user-menu">
            <a href="index.html">Dashboard</a>
            <a href="profile.html">Profile</a>
            <a href="settings.html">Settings</a>
            <button id="logout-btn">Sign Out</button>
          </div>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div id="clock" class="clock"></div>
    </div>
  </header>

  <main style="max-width: 600px; margin: 40px auto;">
    <div class="card">
      <h2>My Profile</h2>
      
      <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;">
        <div class="avatar" id="profile-avatar" style="width:80px; height:80px; font-size:32px;"></div>
        <div>
          <h3 id="profile-username" style="margin:0;"></h3>
          <div class="muted" id="profile-role"></div>
          <label class="btn-primary" style="display:inline-block; margin-top:8px; cursor:pointer; font-size:13px; padding:4px 8px; background: var(--accent); color:white; border-radius:4px;">
            Change Avatar
            <input type="file" id="avatar-upload" accept="image/*" style="display:none">
          </label>
        </div>
      </div>

      <form id="change-password-form">
        <h3>Change Password</h3>
        <div style="margin-bottom:10px;">
          <label>Current Password</label>
          <input type="password" id="old-password" required style="width:100%">
        </div>
        <div style="margin-bottom:10px;">
          <label>New Password</label>
          <input type="password" id="new-password" required style="width:100%">
        </div>
        <div style="margin-bottom:10px;">
          <label>Confirm New Password</label>
          <input type="password" id="confirm-password" required style="width:100%">
        </div>
        <button type="submit">Update Password</button>
      </form>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const u = sessionStorage.getItem('dms_auth_v1');
      if(!u) { window.location.href = 'index.html'; return; }
      
      document.getElementById('profile-username').textContent = u;
      document.getElementById('profile-role').textContent = sessionStorage.getItem('dms_auth_role_v1') || 'User';
      
      // Sync avatar display
      const updateProfileAvatar = () => {
        const navAv = document.getElementById('nav-avatar');
        const profAv = document.getElementById('profile-avatar');
        if(navAv && profAv) profAv.innerHTML = navAv.innerHTML;
      };
      setTimeout(updateProfileAvatar, 500);

      document.getElementById('avatar-upload').addEventListener('change', function(e){
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(ev){
          window.updateAvatar(ev.target.result).then(res => {
            if(res.ok){ alert('Avatar updated'); updateProfileAvatar(); }
            else { alert('Failed: ' + res.error); }
          });
        };
        reader.readAsDataURL(file);
      });

      document.getElementById('change-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const oldP = document.getElementById('old-password').value;
        const newP = document.getElementById('new-password').value;
        const confP = document.getElementById('confirm-password').value;
        if(newP !== confP) { alert('New passwords do not match'); return; }
        const res = await window.changePassword(oldP, newP);
        if(res.ok){ alert('Password changed successfully.'); e.target.reset(); }
        else { alert('Error: ' + (res.error || 'Could not change password')); }
      });
    });
  </script>
</body>
</html>