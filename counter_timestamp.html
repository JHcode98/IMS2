<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Counter Timestamp - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    
    /* Card content expand/collapse */
    .card-content.hidden { display: none; }
    .section-content.hidden { display: none !important; }
    
    /* Icon Button Styles */
    .icon-btn {
        padding: 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; color: #555;
    }
    .icon-btn:hover { background: #f0f0f0; }
    .icon-btn svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
    
    /* Excel-like Report Table */
    .report-table {
        width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #ccc;
    }
    .report-table th, .report-table td {
        border: 1px solid #ccc; padding: 4px 6px; text-align: left;
    }
    .report-table th {
        background-color: #f0f0f0; font-weight: 600; color: #333; white-space: nowrap;
    }
    .report-table tbody tr:nth-child(even) { background-color: #fafafa; }
    .report-table tr:hover { background-color: #eef6ff; }
    
    /* Dark mode overrides */
    body.dark-mode .report-table { border-color: #444; }
    body.dark-mode .report-table th, body.dark-mode .report-table td { border-color: #444; color: #e0e0e0; }
    body.dark-mode .report-table th { background-color: #2c2c2c; }
    body.dark-mode .report-table tbody tr:nth-child(even) { background-color: #1f1f1f; }
    body.dark-mode .report-table tr:hover { background-color: #333; }

    /* Sortable headers */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f1f1f1; }
    .sort-icon { margin-left: 5px; font-size: 10px; }
    body.dark-mode th.sortable:hover { background-color: #333; }

    .editable-time { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
    .editable-time:hover { color: #2752a7; }

    /* Toast Notification Styles */
    .toast {
        visibility: hidden; min-width: 250px; transform: translateX(-50%); background-color: #2ecc71; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 20000; left: 50%; top: 30px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.3s, top 0.3s;
    }
    .toast.show { visibility: visible; opacity: 1; top: 50px; }

    /* Area Card */
    .area-card:hover { border-color: #2752a7 !important; background-color: #f0f4f8; transform: translateY(-2px); }

    /* Tab Styles */
    .tab-header { display: flex; background: #f9f9f9; border-bottom: 1px solid #eee; border-radius: 8px 8px 0 0; }
    .tab-btn { padding: 10px 15px; border: none; background: #f9f9f9; border-right: 1px solid #eee; cursor: pointer; color: #666; font-size: 13px; font-weight: 600; transition: all 0.2s; outline: none; }
    .tab-btn:first-child { border-radius: 8px 0 0 0; }
    .tab-btn.active { background: #fff; color: #2752a7; border-bottom: 2px solid #2752a7; margin-bottom: -1px; }
    .tab-btn:hover:not(.active) { background: #eee; color: #333; }

    /* Sand Timer Animation */
    .sand-timer {
        width: 40px; height: 70px;
        position: relative;
        margin: 0 auto;
        animation: hourglass-rotate 4s ease-in-out infinite;
    }
    .sand-timer-top, .sand-timer-bottom {
        width: 40px; height: 35px;
        position: absolute; left: 0;
        overflow: hidden;
        border: 3px solid #7f8c8d; /* Glass Frame */
        background: rgba(236, 240, 241, 0.3); /* Glass tint */
        box-sizing: border-box;
    }
    .sand-timer-top { top: 0; border-radius: 5px 5px 20px 20px; border-bottom: none; }
    .sand-timer-bottom { bottom: 0; border-radius: 20px 20px 5px 5px; border-top: none; }
    .sand-timer-sand-top {
        position: absolute; left: 50%; transform: translateX(-50%); bottom: 0;
        width: 30px; height: 30px; background: #f39c12; border-radius: 50%;
        animation: sand-drain-top 4s ease-in-out infinite;
    }
    .sand-timer-sand-bottom {
        position: absolute; left: 50%; transform: translateX(-50%); bottom: 0;
        width: 30px; height: 0; background: #f39c12; border-radius: 50% 50% 0 0;
        animation: sand-fill-bottom 4s ease-in-out infinite;
    }
    .sand-timer-stream {
        position: absolute; left: 50%; transform: translateX(-50%); top: 34px;
        width: 2px; height: 0; background: #f39c12;
        animation: sand-stream 4s ease-in-out infinite; z-index: 1;
    }
    @keyframes hourglass-rotate {
        0% { transform: rotate(0deg); } 40% { transform: rotate(0deg); }
        50% { transform: rotate(180deg); } 90% { transform: rotate(180deg); }
        100% { transform: rotate(360deg); }
    }
    @keyframes sand-drain-top {
        0% { height: 30px; width: 30px; } 40% { height: 0; width: 0; }
        50% { height: 0; width: 0; } 50.1% { height: 30px; width: 30px; }
        90% { height: 0; width: 0; } 100% { height: 0; width: 0; }
    }
    @keyframes sand-fill-bottom {
        0% { height: 0; width: 0; } 40% { height: 30px; width: 30px; }
        50% { height: 30px; width: 30px; } 50.1% { height: 0; width: 0; }
        90% { height: 30px; width: 30px; } 100% { height: 30px; width: 30px; }
    }
    @keyframes sand-stream {
        0% { height: 0; } 5% { height: 35px; } 40% { height: 35px; }
        45% { height: 0; } 50% { height: 0; } 55% { height: 35px; }
        90% { height: 35px; } 95% { height: 0; } 100% { height: 0; }
    }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>
  
  <!-- Main App Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button onclick="window.location.href='homepage.html'" data-tooltip="Homepage">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="menu-text">Homepage</span>
        </button>
      </li>
      <li>
        <button data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu" style="display:block">
          <li><button onclick="window.location.href='daily_cycle_count.html'">Daily Cycle Count</button></li>
          <li><button class="active">Counter Timestamp</button></li>
        </ul>
      </li>
    </ul>
  </nav>

  <header>
    <h1>Counter Timestamp</h1>
    <button class="icon-btn" onclick="window.location.href='daily_cycle_count.html'" title="Back" style="position:absolute; right:20px; top:15px;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
    </button>
  </header>

  <main>
    <div class="card" style="height: calc(100vh - 140px); display:flex; flex-direction:column; margin-bottom: 0;">
        <div style="display:flex; gap: 20px; flex:1; overflow:hidden;">
            <!-- Left Column: Controls & Tables -->
            <div style="flex: 2; display:flex; flex-direction:column; gap:10px; overflow-y:auto; padding-right:10px;">
                <!-- Controls -->
                <div>
                    <div style="margin-bottom:10px;">
                    <label for="ts-user-id" style="font-weight:bold;">User ID / Name</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="ts-user-id" placeholder="User ID" style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px;">
                        <input type="text" id="ts-user-name-display" placeholder="Name" readonly style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px; background:#f9f9f9;">
                    </div>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button id="btn-start-count" class="icon-btn" style="flex:1; background:#2ecc71; color:white; padding:10px; font-weight:bold; justify-content:center;">Start Counting</button>
                        <button id="btn-end-count" class="icon-btn" style="flex:1; background:#e74c3c; color:white; padding:10px; font-weight:bold; justify-content:center;">End Counting</button>
                        <button id="btn-time-out" class="icon-btn" style="flex:1; background:#34495e; color:white; padding:10px; font-weight:bold; justify-content:center;">Time Out</button>
                    </div>
                </div>

                <!-- Card 1: Sessions (Active & History) -->
                <div class="card" style="margin:0; padding:0; display:flex; flex-direction:column; max-height:450px; border:1px solid #eee; box-shadow:none;">
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="openTab(event, 'tab-active')">Active Sessions</button>
                        <button class="tab-btn" onclick="openTab(event, 'tab-history')">Session History</button>
                    </div>
                    
                    <div id="tab-active" class="tab-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; gap:5px; align-items:center;">
                            <select id="ts-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                            </select>
                            <input type="text" id="ts-filter-user" placeholder="Search User..." style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
                            <label style="font-size:12px; cursor:pointer; margin-left:5px;"><input type="checkbox" id="ts-show-long-active"> > 1hr</label>
                        </div>
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table id="active-table" class="report-table">
                            <thead>
                                <tr style="position:sticky; top:0;">
                                    <th class="sortable" data-sort="userId">User ID <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedName">Name <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedArea">Area Type <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedShift">Shift <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="startTime">Start Time <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="endTime">End Time <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="durationVal">Duration <span class="sort-icon"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    </div>
                    
                    <div id="tab-history" class="tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; gap:5px; align-items:center; justify-content:flex-end; margin-bottom:5px;">
                            <button id="ts-delete-selected-btn" class="icon-btn" title="Delete Selected" style="padding: 2px 6px; font-size: 12px; color:#d9534f; display:none;">Del Sel</button>
                            <button id="ts-purge-all-btn" class="icon-btn" title="Permanently Delete All Shown" style="padding: 2px 6px; font-size: 12px; background:#c0392b; color:white; border-color:#c0392b;">Purge All</button>
                            <button id="ts-export-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                        </div>
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table id="history-table" class="report-table">
                            <thead>
                                <tr style="position:sticky; top:0;">
                                    <th style="width:30px;"><input type="checkbox" id="ts-select-all"></th>
                                    <th class="sortable" data-sort="userId">User ID <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedName">Name <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedArea">Area Type <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedShift">Shift <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="startTime">Start Time <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="endTime">End Time <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="durationVal">Duration <span class="sort-icon"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="ts-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding-top:5px; margin-top:5px; border-top: 1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <label for="ts-rows-per-page" style="font-size:11px; color:#666;">Rows:</label>
                            <select id="ts-rows-per-page" style="padding: 2px 4px; font-size:11px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <span id="ts-page-info" style="font-size: 11px; font-weight: 600; color: #666;"></span>
                        <div style="display:flex; gap:5px;">
                            <button id="ts-prev-page" class="icon-btn" title="Previous" style="padding:2px 6px; font-size:12px;">‚Äπ</button>
                            <button id="ts-next-page" class="icon-btn" title="Next" style="padding:2px 6px; font-size:12px;">‚Ä∫</button>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Card 2: Users & Breaks -->
                <div class="card" style="margin:0; padding:0; display:flex; flex-direction:column; max-height:400px; border:1px solid #eee; box-shadow:none;">
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="openTab(event, 'tab-inactive')">Inactive Users</button>
                        <button class="tab-btn" onclick="openTab(event, 'tab-breaks')">Break Log</button>
                    </div>

                    <div id="tab-inactive" class="tab-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; justify-content:flex-end; margin-bottom:5px;">
                            <button id="ts-export-inactive-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                        </div>
                        <div style="flex:1; overflow-y:auto; border:1px solid #eee;">
                            <table id="inactive-users-table" class="report-table">
                                <thead>
                                    <tr style="position:sticky; top:0;">
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('userId')">User <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('name')">Name <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('shift')">Shift <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('role')">Role <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('lastEnd')">Last End Count <span class="sort-icon"></span></th>
                                        <th style="text-align:center; width:40px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-breaks" class="tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; gap:5px;">
                             <select id="break-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 80px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                             </select>
                             <label style="font-size:12px; cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="break-show-active"> Active</label>
                             <input type="datetime-local" id="manual-break-time" style="padding:4px; font-size:11px; border:1px solid #ccc; border-radius:4px; width:130px;" title="Manual Break Time">
                             <button id="btn-break-start" class="icon-btn" style="background:#f1c40f; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">Start Break</button>
                             <button id="btn-break-end" class="icon-btn" style="background:#f39c12; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">End Break</button>
                             <button id="break-delete-selected-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; display:none;">Del Sel</button>
                             <button id="break-export-btn" class="icon-btn" title="Export CSV" style="padding:4px 8px; font-size:12px; font-weight:bold;">Export</button>
                             <button id="btn-break-delete-all" class="icon-btn" title="Delete All Breaks" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; margin-left:5px;">üóë All</button>
                        </div>
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee;">
                        <table id="break-log-table" class="report-table">
                            <thead>
                                <tr style="position:sticky; top:0;">
                                    <th style="width:30px;"><input type="checkbox" id="break-select-all"></th>
                                    <th>User</th>
                                    <th>Name</th>
                                    <th>Shift</th>
                                    <th>Role</th>
                                    <th>Break Out</th>
                                    <th>Break In</th>
                                    <th>Duration</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- Right Column: Analytics -->
            <div style="flex: 1; display:flex; flex-direction:column; border-left:1px solid #eee; padding-left:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;">Analytics Overview</h4>
                    <input type="date" id="ts-analytics-date-filter" style="padding:2px 5px; border:1px solid #ccc; border-radius:4px; font-size:12px; color:#333;" title="Filter Analytics Date">
                </div>
                <div id="ts-analytics-content" style="flex: 1; overflow-y: auto;"></div>
                <div style="height: 200px; margin-top: 10px;">
                    <canvas id="timestamp-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
  </main>

  <!-- Start Count Area Selection Modal -->
  <div id="start-area-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Area</h3>
        <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-bin-type="Reserved" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">üì¶</div>
                <div style="font-weight:bold; margin-top:10px;">Reserved Bin</div>
            </div>
            <div class="card area-card" data-bin-type="Pick Bin" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">üõí</div>
                <div style="font-weight:bold; margin-top:10px;">Pick Bin</div>
            </div>
        </div>
        <button id="cancel-start-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Cancel</button>
    </div>
  </div>

  <!-- Warehouse Area Selection Modal -->
  <div id="warehouse-area-modal" class="modal hidden" style="z-index: 10016;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Warehouse Area</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-warehouse-area="Coldroom" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">üå°Ô∏è</div>
                <div style="font-weight:bold; margin-top:10px;">Coldroom</div>
            </div>
            <div class="card area-card" data-warehouse-area="Ecom 2" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">üè¢</div>
                <div style="font-weight:bold; margin-top:10px;">Ecom 2</div>
            </div>
            <div class="card area-card" data-warehouse-area="Storage" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">üè≠</div>
                <div style="font-weight:bold; margin-top:10px;">Storage</div>
            </div>
            <div class="card area-card" data-warehouse-area="Pallet Picking" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">ü™µ</div>
                <div style="font-weight:bold; margin-top:10px;">Pallet Picking</div>
            </div>
        </div>
        <button id="cancel-warehouse-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Back</button>
    </div>
  </div>

  <!-- End Count Details Modal -->
  <div id="end-count-modal" class="modal hidden" style="z-index: 10010;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 300px; margin: 150px auto;">
        <h3 style="margin-top:0">End Count Details</h3>
        <div style="margin-bottom:10px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Area Type:</label>
            <input type="text" id="ec-area-type" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; background-color: #f9f9f9;" readonly>
        </div>
        <div id="ec-pallet-group" style="margin-bottom:10px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Pallets Completed:</label>
            <input type="number" id="ec-pallets" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="0" min="0">
        </div>
        <div style="margin-bottom:15px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">SKUs (Items) Counted:</label>
            <input type="number" id="ec-skus" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="0" min="0">
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button id="ec-cancel-btn" class="icon-btn" style="border:1px solid #ccc;">Cancel</button>
            <button id="ec-save-btn" class="icon-btn" style="background:#2752a7; color:white;">Submit</button>
        </div>
    </div>
  </div>

  <!-- Edit Timestamp Modal -->
  <div id="edit-time-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto;">
        <h3 style="margin-top:0">Edit Timestamp</h3>
        <input type="hidden" id="edit-time-log-id">
        <div style="margin-bottom:15px;">
            <label for="edit-time-input" style="font-weight:bold;">New Date & Time:</label>
            <input type="datetime-local" id="edit-time-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button id="cancel-edit-time-btn" class="icon-btn" style="border:1px solid #ccc;">Cancel</button>
            <button id="save-edit-time-btn" class="icon-btn" style="background:#2752a7; color:white;">Save</button>
        </div>
    </div>
  </div>

  <div id="toast-notification" class="toast"></div>
  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';

    document.addEventListener('DOMContentLoaded', () => {
        // --- Shared Logic from daily_cycle_count.html ---
        const STORAGE_KEY_ATTENDANCE = 'ims_daily_attendance_v1';
        const STORAGE_KEY_TIMESTAMPS = 'ims_counter_timestamps_v1';
        const STORAGE_KEY_COUNTERS = 'ims_daily_counters_v1';
        
        let tsCurrentPage = 1;
        let tsItemsPerPage = 20;
        let tsSortField = 'startTime';
        let tsSortDirection = 'desc';
        let inactiveSort = { field: 'status', dir: 'asc' };
        let cachedInactiveArgs = null;
        let timestampChart = null;

        // Elements
        const tsUserIdInput = document.getElementById('ts-user-id');
        const btnStartCount = document.getElementById('btn-start-count');
        const btnBreakStart = document.getElementById('btn-break-start');
        const btnBreakEnd = document.getElementById('btn-break-end');
        const btnTimeOut = document.getElementById('btn-time-out');
        const btnEndCount = document.getElementById('btn-end-count');
        const activeTableBody = document.querySelector('#active-table tbody');
        const historyTableBody = document.querySelector('#history-table tbody');
        const tsExportBtn = document.getElementById('ts-export-btn');
        const tsFilterUser = document.getElementById('ts-filter-user');
        const tsShiftFilter = document.getElementById('ts-shift-filter');
        const tsExportInactiveBtn = document.getElementById('ts-export-inactive-btn');
        const tsPurgeAllBtn = document.getElementById('ts-purge-all-btn');
        const tsDeleteSelectedBtn = document.getElementById('ts-delete-selected-btn');
        const tsSelectAll = document.getElementById('ts-select-all');
        const tsShowLongActive = document.getElementById('ts-show-long-active');
        const tsAnalyticsDateFilter = document.getElementById('ts-analytics-date-filter');
        
        const endCountModal = document.getElementById('end-count-modal');
        const ecAreaType = document.getElementById('ec-area-type');
        const ecPalletGroup = document.getElementById('ec-pallet-group');
        const ecSaveBtn = document.getElementById('ec-save-btn');
        const ecCancelBtn = document.getElementById('ec-cancel-btn');

        const breakDeleteSelectedBtn = document.getElementById('break-delete-selected-btn');
        const breakExportBtn = document.getElementById('break-export-btn');
        const breakSelectAll = document.getElementById('break-select-all');
        const breakShiftFilter = document.getElementById('break-shift-filter');
        const breakShowActive = document.getElementById('break-show-active');

        const editTimeModal = document.getElementById('edit-time-modal');
        const cancelEditTimeBtn = document.getElementById('cancel-edit-time-btn');
        const saveEditTimeBtn = document.getElementById('save-edit-time-btn');
        
        const startAreaModal = document.getElementById('start-area-modal');
        const warehouseAreaModal = document.getElementById('warehouse-area-modal');
        const cancelStartAreaBtn = document.getElementById('cancel-start-area-btn');
        const cancelWarehouseAreaBtn = document.getElementById('cancel-warehouse-area-btn');
        let selectedBinType = '';

        // Helper Functions
        function getAttendanceData() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_ATTENDANCE) || '[]'); } catch (e) { return []; } }
        function getTimestamps() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TIMESTAMPS) || '[]'); } catch(e) { return []; } }
        function saveTimestamps(data) { localStorage.setItem(STORAGE_KEY_TIMESTAMPS, JSON.stringify(data)); }
        function getCountersData() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_COUNTERS) || '[]'); } catch (e) { return []; } }
        function saveCountersData(data) { localStorage.setItem(STORAGE_KEY_COUNTERS, JSON.stringify(data)); }
        
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        function getShiftFromTimestamp(ts) {
            const d = new Date(ts);
            if (isNaN(d.getTime())) return { date: '', shift: '' };
            const h = d.getHours();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            let dateStr = `${year}-${month}-${day}`;
            let shift = '';
            if (h >= 6 && h < 14) shift = '1st Shift-(6am-2pm)';
            else if (h >= 14 && h < 22) shift = '2nd Shift-(2pm-10pm)';
            else {
                shift = '3rd Shift-(10pm-6am)';
                if (h < 6) {
                    const prev = new Date(d);
                    prev.setDate(d.getDate() - 1);
                    const pYear = prev.getFullYear();
                    const pMonth = String(prev.getMonth() + 1).padStart(2, '0');
                    const pDay = String(prev.getDate()).padStart(2, '0');
                    dateStr = `${pYear}-${pMonth}-${pDay}`;
                }
            }
            return { date: dateStr, shift };
        }

        // --- Core Logic (Copied and adapted from daily_cycle_count.html) ---
        // (Note: I'm including the essential logic for the timestamp functionality to work standalone)
        
        // ... [Insert renderTimestamps, logTimestamp, renderBreakLogTable, renderInactiveUsersTable, renderTsAnalytics, renderTimestampChart logic here] ...
        // For brevity in this response, I will assume the logic is identical to what was in daily_cycle_count.html but scoped to this file.
        // I will paste the full logic block below.

        // [Logic Block Start]
        function renderTimestamps() {
            const data = getTimestamps();
            const attendance = getAttendanceData();
            const filterShift = tsShiftFilter ? tsShiftFilter.value : '';
            const filterUser = tsFilterUser ? tsFilterUser.value.toLowerCase() : '';
            const showActiveOnly = tsShowActive ? tsShowActive.checked : false;
            const showLongActive = tsShowLongActive ? tsShowLongActive.checked : false;
            
            let analyticsDate = tsAnalyticsDateFilter ? tsAnalyticsDateFilter.value : '';
            if (!analyticsDate) {
                analyticsDate = new Date().toISOString().split('T')[0];
                if(tsAnalyticsDateFilter) tsAnalyticsDateFilter.value = analyticsDate;
            }

            let logsToProcess = data;
            logsToProcess.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const sessions = [];
            const openSessions = {};
            
            logsToProcess.forEach(log => {
                if (log.deleted) return;
                if (log.action === 'Start') {
                    if (openSessions[log.userId]) sessions.push(openSessions[log.userId]);
                    openSessions[log.userId] = { userId: log.userId, startLog: log, endLog: null, breaks: [], currentBreakStart: null };
                } else if (log.action === 'Start Break') {
                    if (openSessions[log.userId]) openSessions[log.userId].currentBreakStart = log;
                } else if (log.action === 'End Break') {
                    if (openSessions[log.userId] && openSessions[log.userId].currentBreakStart) {
                        const bStart = new Date(openSessions[log.userId].currentBreakStart.timestamp);
                        const bEnd = new Date(log.timestamp);
                        const bDur = (bEnd - bStart) / 60000;
                        openSessions[log.userId].breaks.push({ start: openSessions[log.userId].currentBreakStart, end: log, duration: bDur });
                        openSessions[log.userId].currentBreakStart = null;
                    }
                } else if (log.action === 'End') {
                    if (openSessions[log.userId]) {
                        const session = openSessions[log.userId];
                        session.endLog = log;
                        sessions.push(session);
                        delete openSessions[log.userId];
                    } else {
                        sessions.push({ userId: log.userId, startLog: null, endLog: log, breaks: [] });
                    }
                }
            });
            Object.values(openSessions).forEach(s => sessions.push(s));

            let filteredSessions = sessions;
            if (filterShift) {
                filteredSessions = filteredSessions.filter(s => {
                    let shiftToCheck = '';
                    let sessionDate = '';
                    if (s.startLog) {
                        const info = getShiftFromTimestamp(s.startLog.timestamp);
                        sessionDate = info.date;
                        shiftToCheck = info.shift;
                    } else if (s.endLog) {
                        const info = getShiftFromTimestamp(s.endLog.timestamp);
                        sessionDate = info.date;
                        shiftToCheck = info.shift;
                    }
                    const attRecord = attendance.find(a => a.userId === s.userId && a.date === sessionDate);
                    if (attRecord && attRecord.shift) shiftToCheck = attRecord.shift;
                    return shiftToCheck.includes(filterShift);
                });
            }
            if (filterUser) {
                const terms = filterUser.split(' ').filter(t => t);
                filteredSessions = sessions.filter(s => {
                    const attRecord = attendance.find(a => a.userId === s.userId);
                    const name = attRecord ? attRecord.name : '';
                    const shiftInfo = s.startLog ? getShiftFromTimestamp(s.startLog.timestamp) : { shift: '' };
                    const searchStr = (s.userId + ' ' + name + ' ' + shiftInfo.shift).toLowerCase();
                    return terms.every(term => searchStr.includes(term));
                });
            }
            if (showLongActive) {
                const now = new Date();
                filteredSessions = filteredSessions.filter(s => {
                    if (s.endLog) return false;
                    const diff = now - new Date(s.startLog.timestamp);
                    return (diff / 60000) > 60;
                });
            }

            const now = new Date();
            filteredSessions.forEach(s => {
                const ts = s.startLog ? s.startLog.timestamp : (s.endLog ? s.endLog.timestamp : null);
                let sessionDate = '';
                if (ts) {
                    const d = new Date(ts);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    sessionDate = `${year}-${month}-${day}`;
                }
                let attRecord = attendance.find(a => a.userId === s.userId && a.date === sessionDate);
                if (!attRecord) attRecord = attendance.find(a => a.userId === s.userId);
                
                s.resolvedName = attRecord ? attRecord.name : '-';
                s.resolvedShift = attRecord && attRecord.shift ? attRecord.shift : (s.startLog ? getShiftFromTimestamp(s.startLog.timestamp).shift : '-');
                s.resolvedArea = s.startLog ? (s.startLog.areaType || '-') : '-';
                s.startTime = s.startLog ? s.startLog.timestamp : (s.endLog ? s.endLog.timestamp : '');
                s.endTime = s.endLog ? s.endLog.timestamp : '';
                
                let durationMins = 0;
                const totalBreakMins = s.breaks ? s.breaks.reduce((acc, b) => acc + b.duration, 0) : 0;
                if (s.startLog && s.endLog) {
                    const diff = new Date(s.endLog.timestamp) - new Date(s.startLog.timestamp);
                    durationMins = Math.round((diff / 60000) - totalBreakMins);
                } else if (s.startLog) {
                    const diff = now - new Date(s.startLog.timestamp);
                    durationMins = Math.floor(diff / 60000);
                }
                s.durationVal = durationMins;
            });

            filteredSessions.sort((a,b) => {
                let valA = a[tsSortField];
                let valB = b[tsSortField];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return tsSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return tsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Split into Active and History
            const activeSessions = filteredSessions.filter(s => !s.endLog);
            const historySessions = filteredSessions.filter(s => {
                if (!s.endLog) return false;
                const d = new Date(s.endLog.timestamp);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const localDate = `${year}-${month}-${day}`;
                return localDate === analyticsDate;
            });

            // Pagination for History
            const totalItems = historySessions.length;
            const totalPages = Math.ceil(totalItems / tsItemsPerPage) || 1;
            if (tsCurrentPage > totalPages) tsCurrentPage = totalPages;
            if (tsCurrentPage < 1) tsCurrentPage = 1;
            
            const paginatedHistory = historySessions.slice((tsCurrentPage - 1) * tsItemsPerPage, tsCurrentPage * tsItemsPerPage);
            
            const tsPageInfo = document.getElementById('ts-page-info');
            if(tsPageInfo) {
                tsPageInfo.textContent = `Page ${tsCurrentPage} of ${totalPages} (${totalItems})`;
                document.getElementById('ts-prev-page').disabled = tsCurrentPage <= 1;
                document.getElementById('ts-next-page').disabled = tsCurrentPage >= totalPages;
            }
            
            // Update Sort Icons
            document.querySelectorAll('.report-table th.sortable .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeader = document.querySelector(`.report-table th[data-sort="${tsSortField}"]`);
            if(activeHeader) {
                document.querySelectorAll(`.report-table th[data-sort="${tsSortField}"] .sort-icon`).forEach(icon => icon.textContent = tsSortDirection === 'asc' ? '‚Üë' : '‚Üì');
            }

            // Render Active Table
            activeTableBody.innerHTML = '';
            if(activeSessions.length === 0) {
                activeTableBody.innerHTML = '<tr><td colspan="8" style="padding:10px; text-align:center; color:#999;">No active sessions.</td></tr>';
            } else {
                activeSessions.forEach(session => {
                    const tr = createSessionRow(session, false);
                    activeTableBody.appendChild(tr);
                });
            }

            // Render History Table
            historyTableBody.innerHTML = '';
            if(paginatedHistory.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="9" style="padding:10px; text-align:center; color:#999;">No history logs.</td></tr>';
                if(tsSelectAll) tsSelectAll.checked = false;
            } else {
                paginatedHistory.forEach(session => {
                    const tr = createSessionRow(session, true);
                    historyTableBody.appendChild(tr);
                });
            }
            updateTsDeleteButton();
            
            const chartSessions = historySessions.filter(s => s.duration > 0).map(s => ({
                user: s.userId,
                shift: s.shift,
                duration: s.duration,
                end: s.endLog.timestamp
            }));
            try { renderTimestampChart(chartSessions); } catch(e) { console.error(e); }
            try { renderTsAnalytics(sessions, analyticsDate, logsToProcess); } catch(e) { console.error(e); }
            try { renderBreakLogTable(logsToProcess, attendance); } catch(e) { console.error(e); }
            cachedInactiveArgs = [sessions, attendance, logsToProcess];
            renderInactiveUsersTable(sessions, attendance, logsToProcess);
        }

        function createSessionRow(session, isHistory) {
            const userId = session.userId;
            const name = session.resolvedName;
            const areaTypeDisplay = session.resolvedArea;
            const shiftDisplay = session.resolvedShift.split('-')[0];
            const datePrefix = (session.startLog) ? new Date(session.startLog.timestamp).toLocaleDateString() + ' ' : '';
            const startStr = session.startLog ? `<span class="editable-time" data-log-id="${session.startLog.id}">${datePrefix + new Date(session.startLog.timestamp).toLocaleTimeString()}</span>` : '-';
            const endStr = session.endLog ? `<span class="editable-time" data-log-id="${session.endLog.id}">${new Date(session.endLog.timestamp).toLocaleTimeString()}</span>` : '-';
            
            let duration = '-';
            let isHigh = false;
            const durationMins = session.durationVal;
            
            if (session.endLog) {
                duration = `${durationMins} min`;
                if (durationMins >= 30) isHigh = true;
            } else if (session.startLog) {
                duration = `Active (${durationMins}m)`;
                if (durationMins > 60) {
                    duration += ' ‚ö†Ô∏è > 1hr';
                    isHigh = true; 
                }
            }
            session.duration = durationMins;
            session.shift = session.resolvedShift;
            
            const tr = document.createElement('tr');
            if ((session.startLog && session.startLog.deleted) || (session.endLog && session.endLog.deleted)) {
                tr.style.opacity = '0.5';
                tr.style.background = '#f9f9f9';
            }
            
            const idsToDelete = [session.startLog?.id, session.endLog?.id, ...(session.breaks || []).flatMap(b => [b.start.id, b.end.id])].filter(x=>x).join(',');
            const deleteAction = `<button class="icon-btn delete-action-btn" onclick="deleteSession('${idsToDelete}')" title="Permanently Delete Session" style="color:#d9534f; opacity:0; transition:opacity 0.2s;">&times;</button>`;
            const rowIds = idsToDelete;
            
            let quickAction = '';
            if (!session.endLog) {
                if (session.currentBreakStart) {
                    quickAction = `<button class="icon-btn quick-action-btn" onclick="logTimestamp('End Break', null, '${userId}')" title="End Break" style="color:#f39c12; margin-right:4px; opacity:0; transition:opacity 0.2s;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>`;
                } else {
                    quickAction = `<button class="icon-btn quick-action-btn" onclick="logTimestamp('End', null, '${userId}')" title="End Counting" style="color:#e74c3c; margin-right:4px; opacity:0; transition:opacity 0.2s;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button>`;
                }
            }

            let checkboxHtml = isHistory ? `<td><input type="checkbox" class="ts-row-checkbox" data-ids="${rowIds}"></td>` : '';
            
            tr.innerHTML = `${checkboxHtml}<td>${userId}</td><td>${name}</td><td>${areaTypeDisplay}</td><td>${shiftDisplay}</td><td style="color:#2ecc71; font-weight:bold;">${startStr}</td><td style="color:#e74c3c; font-weight:bold;">${endStr}</td><td style="${isHigh ? 'color:#e74c3c; font-weight:bold;' : (duration.includes('Active')?'color:#2ecc71;font-weight:bold':'')}">${duration}</td><td>${quickAction}${deleteAction}</td>`;
            
            tr.onmouseenter = () => { tr.querySelectorAll('.quick-action-btn').forEach(b => b.style.opacity = '1'); tr.querySelectorAll('.delete-action-btn').forEach(b => b.style.opacity = '1'); };
            tr.onmouseleave = () => { tr.querySelectorAll('.quick-action-btn').forEach(b => b.style.opacity = '0'); tr.querySelectorAll('.delete-action-btn').forEach(b => b.style.opacity = '0'); };
            return tr;
        }

        function logTimestamp(action, areaType, customUserId) {
            let userId = customUserId;
            if (!userId) userId = tsUserIdInput.value.trim();
            if(!userId) { alert('Please enter User ID.'); return; }
            const data = getTimestamps();
            const userLogs = data.filter(d => d.userId === userId && !d.deleted).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            const lastLog = userLogs[userLogs.length - 1];
            let now = new Date();
            const manualBreakInput = document.getElementById('manual-break-time');
            if (manualBreakInput && manualBreakInput.value && (action === 'Start Break' || action === 'End Break')) {
                now = new Date(manualBreakInput.value);
            }
            
            if (action === 'Start' || action === 'Start Break') {
                const attData = getAttendanceData();
                const userExists = attData.some(a => a.userId === userId);
                if (!userExists) { alert(`User ID ${userId} not found in attendance list.`); return; }
                if (lastLog && lastLog.action !== 'End' && lastLog.action !== 'End Break') {
                    if (lastLog.action === 'Start Break') { alert(`User ${userId} is currently on break.`); return; }
                    alert(`User ${userId} already has an active session.`); return;
                }
            } else if (action === 'Start Break') {
                if (lastLog && lastLog.action === 'Start Break') { alert(`User ${userId} is already on break.`); return; }
                if (lastLog && lastLog.action === 'Start') { alert(`User ${userId} has an active counting session. End Counting first.`); return; }
            } else if (action === 'End Break') {
                if (!lastLog || lastLog.action !== 'Start Break') { alert(`User ${userId} is not on break.`); return; }
            } else if (action === 'End') {
                if (!lastLog || (lastLog.action === 'End')) { alert(`Cannot End Counting: No active 'Start' found.`); return; }
            }

            if (action === 'Start' && !areaType) {
                document.getElementById('start-area-modal').classList.remove('hidden');
                return;
            }

            if (action === 'End') {
                const userLogs = data.filter(d => d.userId === userId && !d.deleted).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                let startLog = null;
                for (let i = userLogs.length - 1; i >= 0; i--) {
                    if (userLogs[i].action === 'Start') { startLog = userLogs[i]; break; }
                    if (userLogs[i].action === 'End') break;
                }
                const area = startLog ? (startLog.areaType || 'Reserved') : 'Reserved';
                document.getElementById('ec-pallets').value = '';
                document.getElementById('ec-skus').value = '';
                document.getElementById('ec-area-type').value = area;
                if (area && area.startsWith('Pick Bin')) { ecPalletGroup.style.display = 'none'; document.getElementById('ec-pallets').value = 0; } 
                else { ecPalletGroup.style.display = 'block'; }
                endCountModal.dataset.userId = userId;
                endCountModal.classList.remove('hidden');
                return;
            }

            const newLog = { id: Date.now().toString(), userId: userId, action: action, timestamp: now.toISOString() };
            if (areaType) newLog.areaType = areaType;
            data.push(newLog);
            saveTimestamps(data);

            if (action === 'Start Break' || action === 'End Break' || action === 'Time Out') {
                const attData = getAttendanceData();
                const todayStr = now.toISOString().split('T')[0];
                let attIdx = attData.findIndex(a => a.userId === userId && a.date === todayStr);
                if (attIdx === -1) {
                    const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    attIdx = attData.findIndex(a => a.userId === userId && a.date === yesterdayStr);
                }
                if (attIdx > -1) {
                    const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                    if (action === 'Start Break') attData[attIdx].breakOut = timeStr;
                    else if (action === 'End Break') attData[attIdx].breakIn = timeStr;
                    else if (action === 'Time Out') attData[attIdx].timeOut = timeStr;
                    localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(attData));
                }
            }

            renderTimestamps();
            showToast(`${action} recorded for ${userId}`);
            if (!customUserId) {
                tsUserIdInput.value = '';
                const nameDisplay = document.getElementById('ts-user-name-display');
                if(nameDisplay) nameDisplay.value = '';
                tsUserIdInput.focus();
            }
            if(manualBreakInput) manualBreakInput.value = '';
        }
        window.logTimestamp = logTimestamp;

        // ... [Include renderBreakLogTable, renderInactiveUsersTable, renderTsAnalytics, renderTimestampChart, updateTsDeleteButton, updateBreakDeleteButton, sortInactiveTable logic here] ...
        // For brevity, assuming these functions are copied from daily_cycle_count.html
        
        function updateTsDeleteButton() {
            const count = document.querySelectorAll('.ts-row-checkbox:checked').length;
            if(tsDeleteSelectedBtn) tsDeleteSelectedBtn.style.display = count > 0 ? 'inline-block' : 'none';
        }
        
        function updateBreakDeleteButton() {
            const count = document.querySelectorAll('.break-row-checkbox:checked').length;
            if(breakDeleteSelectedBtn) breakDeleteSelectedBtn.style.display = count > 0 ? 'inline-block' : 'none';
        }

        window.sortInactiveTable = function(field) {
            if (inactiveSort.field === field) {
                inactiveSort.dir = inactiveSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                inactiveSort.field = field;
                inactiveSort.dir = 'asc';
            }
            if (cachedInactiveArgs) renderInactiveUsersTable(...cachedInactiveArgs);
        };

        function renderBreakLogTable(logs, attendanceData) {
             const tbody = document.querySelector('#break-log-table tbody');
             if(!tbody) return;
             tbody.innerHTML = '';
             
             const breaks = [];
             const openBreaks = {};
             const now = new Date();
             
             // Sort logs by time ascending
             const sortedLogs = [...logs].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
             
             sortedLogs.forEach(log => {
                 if (log.userId && !log.deleted) {
                     if (log.action === 'Start Break') openBreaks[log.userId] = log;
                     else if (log.action === 'End Break' && openBreaks[log.userId]) {
                         breaks.push({ userId: log.userId, start: openBreaks[log.userId].timestamp, end: log.timestamp, startId: openBreaks[log.userId].id, endId: log.id });
                         delete openBreaks[log.userId];
                     }
                 }
             });
             
             // Add open breaks
             Object.keys(openBreaks).forEach(uid => {
                  breaks.push({ userId: uid, start: openBreaks[uid].timestamp, end: null, startId: openBreaks[uid].id, endId: null });
             });
             
             // Filters
             const filterShift = breakShiftFilter ? breakShiftFilter.value : '';
             const showActive = breakShowActive ? breakShowActive.checked : false;
             const dateInput = document.getElementById('ts-analytics-date-filter');
             const filterDate = dateInput && dateInput.value ? dateInput.value : '';
             
             const filteredBreaks = breaks.filter(b => {
                 if (showActive && b.end) return false;
                 if (filterShift) {
                     const att = attendanceData.find(a => a.userId === b.userId) || {};
                     const shift = att.shift || '';
                     if (!shift.includes(filterShift)) return false;
                 }
                 if (filterDate) {
                     const d = new Date(b.start);
                     const year = d.getFullYear();
                     const month = String(d.getMonth() + 1).padStart(2, '0');
                     const day = String(d.getDate()).padStart(2, '0');
                     const localDate = `${year}-${month}-${day}`;
                     if (localDate !== filterDate) return false;
                 }
                 return true;
             });

             filteredBreaks.sort((a,b) => new Date(b.start) - new Date(a.start));
             
             if(filteredBreaks.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="9" style="padding:10px; text-align:center; color:#999;">No breaks recorded.</td></tr>';
                 if(breakSelectAll) breakSelectAll.checked = false;
                 return;
             }

             filteredBreaks.forEach(b => {
                 const att = attendanceData.find(a => a.userId === b.userId) || {};
                 const name = att.name || '-';
                 const shift = att.shift ? att.shift.split('-')[0] : '-';
                 const role = att.role || '-';
                 
                 const start = new Date(b.start);
                 const end = b.end ? new Date(b.end) : now;
                 const durationMs = end - start;
                 const durationMins = Math.floor(durationMs / 60000);
                 
                 let durationDisplay = `${durationMins} min`;
                 let rowStyle = '';
                 
                 if (!b.end) {
                     durationDisplay = `Running (${durationMins} min)`;
                     if (durationMins > 40) {
                         rowStyle = 'background-color: #ffebee; color: #c0392b; font-weight: bold;';
                         durationDisplay += ' ‚ö†Ô∏è > 40m';
                     } else {
                         durationDisplay = `<span style="color:orange">${durationDisplay}</span>`;
                     }
                 }
                 
                 const startStr = `<span class="editable-time" data-log-id="${b.startId}">${start.toLocaleTimeString()}</span>`;
                 const endStr = b.end ? `<span class="editable-time" data-log-id="${b.endId}">${new Date(b.end).toLocaleTimeString()}</span>` : '-';

                 let endBreakBtn = '';
                 if (!b.end) {
                     endBreakBtn = `<button class="icon-btn end-break-btn" onclick="logTimestamp('End Break', null, '${b.userId}')" title="End Break" style="color:#f39c12; padding:2px 6px; font-size:10px; opacity:0; transition:opacity 0.2s; margin-right:4px;">
                         <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                     </button>`;
                 }

                 const deleteBtn = `<button class="icon-btn delete-break-btn" onclick="deleteBreak('${b.startId}', '${b.endId}')" title="Delete Break" style="color:#d9534f; padding:2px 6px; font-size:10px; opacity:0; transition:opacity 0.2s;">&times;</button>`;
                 const rowIds = [b.startId, b.endId].filter(x=>x).join(',');

                 const tr = document.createElement('tr');
                 if (rowStyle) tr.style.cssText = rowStyle;
                 tr.innerHTML = `<td><input type="checkbox" class="break-row-checkbox" data-ids="${rowIds}"></td><td>${b.userId}</td><td>${name}</td><td>${shift}</td><td>${role}</td><td>${startStr}</td><td>${endStr}</td><td>${durationDisplay}</td><td>${endBreakBtn}${deleteBtn}</td>`;
                 
                 tr.onmouseenter = () => { 
                     tr.querySelectorAll('.delete-break-btn').forEach(b => b.style.opacity = '1'); 
                     tr.querySelectorAll('.end-break-btn').forEach(b => b.style.opacity = '1');
                 };
                 tr.onmouseleave = () => { 
                     tr.querySelectorAll('.delete-break-btn').forEach(b => b.style.opacity = '0'); 
                     tr.querySelectorAll('.end-break-btn').forEach(b => b.style.opacity = '0');
                 };
                 
                 tbody.appendChild(tr);
             });
             updateBreakDeleteButton();
        }
        
        function renderInactiveUsersTable(sessions, attendanceData, logs) {
             const tbody = document.querySelector('#inactive-users-table tbody');
             if(!tbody) return;
             tbody.innerHTML = '';
             const filterShift = tsShiftFilter ? tsShiftFilter.value : '';
             
             const dateInput = document.getElementById('ts-analytics-date-filter');
             let filterDate = dateInput && dateInput.value ? dateInput.value : '';
             if (!filterDate) {
                 const now = new Date();
                 const year = now.getFullYear();
                 const month = String(now.getMonth() + 1).padStart(2, '0');
                 const day = String(now.getDate()).padStart(2, '0');
                 filterDate = `${year}-${month}-${day}`;
             }
             
             // Get all Full Counters for the date
             const fullCounters = attendanceData.filter(a => a.date === filterDate && a.status === 'Full counter');
             
             // Map of userId -> last end timestamp (from sessions)
             const userLastEnd = {};
             const activeUserIds = new Set();
             
             sessions.forEach(s => {
                 if (!s.endLog) {
                     activeUserIds.add(s.userId);
                 } else {
                     const t = new Date(s.endLog.timestamp).getTime();
                     if (!userLastEnd[s.userId] || t > userLastEnd[s.userId]) {
                         userLastEnd[s.userId] = t;
                     }
                 }
             });

             // Determine users currently on break
             const onBreakUserIds = new Set();
             const userLastAction = {};
             logs.forEach(l => { if (!l.deleted) userLastAction[l.userId] = l.action; });
             Object.entries(userLastAction).forEach(([uid, action]) => {
                 if (action === 'Start Break') onBreakUserIds.add(uid);
             });
             
             const inactiveList = [];
             
             fullCounters.forEach(att => {
                 if (filterShift && !att.shift.includes(filterShift)) return;
                 if (att.timeOut) return; // Skip if already timed out
                 if (!activeUserIds.has(att.userId)) {
                     // Not currently active session
                     let lastEnd = '-';
                     let status = 'Not Started';
                     
                     if (userLastEnd[att.userId]) {
                         lastEnd = new Date(userLastEnd[att.userId]).toLocaleTimeString();
                         status = 'Inactive';
                     }

                     // If on break, do not add to inactive list
                     if (onBreakUserIds.has(att.userId)) return;
                     
                     inactiveList.push({
                         userId: att.userId,
                         name: att.name,
                         shift: att.shift,
                         role: att.role,
                         lastEnd: lastEnd,
                         status: status
                     });
                 }
             });
             
             if(inactiveList.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="padding:10px; text-align:center; color:#999;">No inactive users found.</td></tr>'; return; }
             
             // Sort: Not Started first
             if (inactiveSort.field) {
                 inactiveList.sort((a,b) => {
                     const valA = (a[inactiveSort.field] || '').toString().toLowerCase();
                     const valB = (b[inactiveSort.field] || '').toString().toLowerCase();
                     return inactiveSort.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                 });
             }
             inactiveList.sort((a,b) => {
                 if (a.status === 'Not Started' && b.status !== 'Not Started') return -1;
                 if (a.status !== 'Not Started' && b.status === 'Not Started') return 1;
                 return 0;
             });
             
             inactiveList.forEach(u => {
                 const tr = document.createElement('tr');
                 const color = u.status === 'Not Started' ? '#e74c3c' : '#333';
                 
                 const startBtn = `<button class="icon-btn quick-start-btn" 
                     onclick="document.getElementById('ts-user-id').value = '${u.userId}'; document.getElementById('ts-user-id').dispatchEvent(new Event('input')); logTimestamp('Start', null, '${u.userId}')" 
                     title="Quick Start Count" 
                     style="color:#2ecc71; padding:2px; opacity:0; transition:opacity 0.2s; margin-right:4px;">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                 </button>`;

                 const breakBtn = `<button class="icon-btn quick-start-btn" 
                     onclick="document.getElementById('ts-user-id').value = '${u.userId}'; document.getElementById('ts-user-id').dispatchEvent(new Event('input')); logTimestamp('Start Break', null, '${u.userId}')" 
                     title="Quick Break" 
                     style="color:#3498db; padding:2px; opacity:0; transition:opacity 0.2s;">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
                 </button>`;

                 tr.innerHTML = `<td style="color:${color}">${u.userId}</td><td style="color:${color}">${u.name}</td><td style="color:${color}">${u.shift || '-'}</td><td style="color:${color}">${u.role || '-'}</td><td style="color:${color}">${u.lastEnd}</td><td style="text-align:center; white-space:nowrap;">${startBtn}${breakBtn}</td>`;
                 
                 tr.onmouseenter = () => { tr.querySelectorAll('.quick-start-btn').forEach(b => b.style.opacity = '1'); };
                 tr.onmouseleave = () => { tr.querySelectorAll('.quick-start-btn').forEach(b => b.style.opacity = '0'); };
                 
                 tbody.appendChild(tr);
             });
             
             // Update sort icons
             document.querySelectorAll('#inactive-users-table th .sort-icon').forEach(el => el.textContent = '');
             const activeTh = document.querySelector(`#inactive-users-table th[onclick*="'${inactiveSort.field}'"] .sort-icon`);
             if(activeTh) activeTh.textContent = inactiveSort.dir === 'asc' ? '‚Üë' : '‚Üì';
        }

        function renderTsAnalytics(sessions, date, logs) {
             const container = document.getElementById('ts-analytics-content');
             if(!container) return;
             container.innerHTML = '';
             
             // 1. Attendance Stats (Full vs Temp)
             const attendance = getAttendanceData().filter(a => a.date === date);
             const activeUserIds = new Set(sessions.filter(s => !s.endLog).map(s => s.userId));
             
             const shiftData = {
                 '1st Shift-(6am-2pm)': { full: 0, fullActive: 0, temp: 0, timedOut: 0 },
                 '2nd Shift-(2pm-10pm)': { full: 0, fullActive: 0, temp: 0, timedOut: 0 },
                 '3rd Shift-(10pm-6am)': { full: 0, fullActive: 0, temp: 0, timedOut: 0 }
             };
             
             let totalTemp = 0;
             attendance.forEach(a => {
                 if (shiftData[a.shift]) {
                     if (a.status === 'Full counter') {
                         shiftData[a.shift].full++;
                         if (activeUserIds.has(a.userId)) shiftData[a.shift].fullActive++;
                         if (a.timeOut) shiftData[a.shift].timedOut++;
                     }
                     if (a.status === 'Temporary slide to Other task') {
                         shiftData[a.shift].temp++;
                         totalTemp++;
                     }
                 }
             });

             // Calculate Inactive Users
             const onBreakUserIds = new Set();
             const userLastAction = {};
             logs.forEach(l => { if (!l.deleted) userLastAction[l.userId] = l.action; });
             Object.entries(userLastAction).forEach(([uid, action]) => {
                 if (action === 'Start Break') onBreakUserIds.add(uid);
             });

             let inactiveCount = 0;
             const filterShift = tsShiftFilter ? tsShiftFilter.value : '';
             attendance.forEach(a => {
                 if (a.status === 'Full counter') {
                     if (filterShift && !a.shift.includes(filterShift)) return;
                     if (a.timeOut) return;
                     if (!activeUserIds.has(a.userId) && !onBreakUserIds.has(a.userId)) {
                         inactiveCount++;
                     }
                 }
             });

             // 2. Session Stats
             const userStarts = {};
             let totalDuration = 0;
             let completedSessions = 0;
             let activeSessions = 0;
             let totalBreaks = 0;

             sessions.forEach(s => {
                 userStarts[s.userId] = (userStarts[s.userId] || 0) + 1;
                 if (s.duration > 0) {
                     totalDuration += s.duration;
                     completedSessions++;
                 } else if (!s.endLog) {
                     activeSessions++;
                 }
                 if (s.breaks) totalBreaks += s.breaks.length;
             });

             const usersWithBreaks = new Set();
             logs.forEach(l => { if (l.action === 'Start Break') usersWithBreaks.add(l.userId); });
             const uniqueBreakUsers = usersWithBreaks.size;
             
             let mostFreqUser = '-'; let mostFreqCount = 0; let mostFreqName = '-';
             let leastFreqUser = '-'; let leastFreqCount = Infinity; let leastFreqName = '-';
             
             Object.entries(userStarts).forEach(([user, count]) => {
                 if (count > mostFreqCount) { mostFreqCount = count; mostFreqUser = user; const att = attendance.find(a => a.userId === user); if(att) mostFreqName = att.name; }
                 if (count < leastFreqCount) { leastFreqCount = count; leastFreqUser = user; const att = attendance.find(a => a.userId === user); if(att) leastFreqName = att.name; }
             });
             if (leastFreqCount === Infinity) leastFreqCount = 0;

             let userListHtml = '<div style="margin-top:10px; max-height:150px; overflow-y:auto; border:1px solid #eee;"><table style="width:100%; font-size:12px; border-collapse:collapse;"><thead><tr style="background:#f9f9f9;"><th style="padding:4px; text-align:left;">User</th><th style="padding:4px; text-align:left;">Name</th><th style="padding:4px; text-align:right;">Starts</th></tr></thead><tbody>';
             const sortedUsers = Object.entries(userStarts).sort((a,b) => b[1] - a[1]);
             sortedUsers.forEach(([u, c]) => {
                 const att = attendance.find(a => a.userId === u);
                 const name = att ? att.name : '-';
                 userListHtml += `<tr><td style="padding:4px; border-bottom:1px solid #eee;">${u}</td><td style="padding:4px; border-bottom:1px solid #eee;">${name}</td><td style="padding:4px; border-bottom:1px solid #eee; text-align:right;">${c}</td></tr>`;
             });
             userListHtml += '</tbody></table></div>';

             const avgDuration = completedSessions > 0 ? Math.round(totalDuration / completedSessions) : 0;

             let html = `
                 <div style="margin-bottom:15px;">
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                         <h5 style="margin:0; color:#2752a7;">Full Counters (Active / Total)</h5>
                         <span style="font-size:11px; color:#f57c00; font-weight:bold;">Temp Slide: ${totalTemp}</span>
                     </div>
                     <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                         <div class="card" style="padding:10px; text-align:center; background:#e8f5e9; border:1px solid #c8e6c9; margin:0;">
                             <div style="font-size:11px; color:#2e7d32;">1st Shift</div>
                             <div style="font-weight:bold; color:#2ecc71; font-size:20px;">${shiftData['1st Shift-(6am-2pm)'].fullActive} <span style="color:#2e7d32; font-size:14px;">/ ${shiftData['1st Shift-(6am-2pm)'].full}</span></div>
                         </div>
                         <div class="card" style="padding:10px; text-align:center; background:#e8f5e9; border:1px solid #c8e6c9; margin:0;">
                             <div style="font-size:11px; color:#2e7d32;">2nd Shift</div>
                             <div style="font-weight:bold; color:#2ecc71; font-size:20px;">${shiftData['2nd Shift-(2pm-10pm)'].fullActive} <span style="color:#2e7d32; font-size:14px;">/ ${shiftData['2nd Shift-(2pm-10pm)'].full}</span></div>
                         </div>
                         <div class="card" style="padding:10px; text-align:center; background:#e8f5e9; border:1px solid #c8e6c9; margin:0;">
                             <div style="font-size:11px; color:#2e7d32;">3rd Shift</div>
                             <div style="font-weight:bold; color:#2ecc71; font-size:20px;">${shiftData['3rd Shift-(10pm-6am)'].fullActive} <span style="color:#2e7d32; font-size:14px;">/ ${shiftData['3rd Shift-(10pm-6am)'].full}</span></div>
                         </div>
                     </div>
                 </div>
                 <div style="background:#f8f9fa; border-radius:6px; padding:12px; margin-bottom:10px; border:1px solid #eee;">
                     <h5 style="margin:0 0 8px 0; color:#2752a7;">Session Insights</h5>
                     <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px;"><span>Most Frequent:</span><strong>${mostFreqUser} (${mostFreqCount})</strong></div>
                     <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px;"><span>Avg. Duration:</span><strong>${avgDuration} min</strong></div>
                     <div style="display:flex; justify-content:space-between; font-size:13px;"><span>Active Sessions:</span><strong style="color:${activeSessions > 0 ? '#2ecc71' : '#666'}">${activeSessions}</strong></div>
                     ${userListHtml}
                 </div>
                 <div style="background:#fff; border-radius:6px; padding:12px; border:1px solid #eee;">
                     <h5 style="margin:0 0 8px 0; color:#666;">Stats</h5>
                     <ul style="margin:0; padding-left:20px; font-size:12px; color:#555;">
                         <li>Total Breaks: <strong>${totalBreaks}</strong></li>
                         <li>Completed Sessions: <strong>${completedSessions}</strong></li>
                         <li>Total Hours: <strong>${Math.round(totalDuration/60)}h</strong></li>
                         <li>Inactive Users: <strong style="color:${inactiveCount > 0 ? '#e74c3c' : '#2ecc71'}">${inactiveCount}</strong></li>
                     </ul>
                 </div>
                 <div style="text-align:center; margin-top:20px;">
                    <div class="sand-timer" title="Shift Countdown">
                        <div class="sand-timer-top"><div class="sand-timer-sand-top"></div></div>
                        <div class="sand-timer-bottom"><div class="sand-timer-sand-bottom"></div></div>
                        <div class="sand-timer-stream"></div>
                    </div>
                    <div id="shift-countdown-display" style="margin-top:8px; font-weight:bold; color:#e74c3c; font-size:18px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">--h --m --s</div>
                    <div id="shift-countdown-label" style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:1px;">Shift Remaining</div>
                </div>
             `;
             container.innerHTML = html;
             
             if (!window.shiftTimerInterval) {
                const updateTimer = () => {
                    const el = document.getElementById('shift-countdown-display');
                    const labelEl = document.getElementById('shift-countdown-label');
                    if (!el) return;
                    
                    const now = new Date();
                    const h = now.getHours();
                    let end = new Date(now);
                    let shiftName = '';
                    
                    if (h >= 6 && h < 14) {
                        shiftName = '1st Shift';
                        end.setHours(14, 0, 0, 0);
                    } else if (h >= 14 && h < 22) {
                        shiftName = '2nd Shift';
                        end.setHours(22, 0, 0, 0);
                    } else {
                        shiftName = '3rd Shift';
                        if (h >= 22) {
                            end.setDate(end.getDate() + 1);
                            end.setHours(6, 0, 0, 0);
                        } else {
                            end.setHours(6, 0, 0, 0);
                        }
                    }
                    
                    let diff = end - now;
                    if (diff < 0) diff = 0;
                    
                    const hh = Math.floor(diff / 3600000);
                    const mm = Math.floor((diff % 3600000) / 60000);
                    const ss = Math.floor((diff % 60000) / 1000);
                    
                    el.textContent = `${hh}h ${mm}m ${ss}s`;
                    if(labelEl) labelEl.textContent = `${shiftName} Ends`;
                };
                window.shiftTimerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            }
        }

        function renderTimestampChart(sessions) {
             const ctx = document.getElementById('timestamp-chart');
             if (!ctx || typeof Chart === 'undefined') return;
             if (timestampChart) timestampChart.destroy();
             // Minimal chart
             timestampChart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [] } });
        }

        // Event Listeners
        if(btnStartCount) btnStartCount.addEventListener('click', () => logTimestamp('Start'));
        if(btnBreakStart) btnBreakStart.addEventListener('click', () => { const uid = tsUserIdInput.value.trim(); logTimestamp('Start Break', null, uid); });
        if(btnBreakEnd) btnBreakEnd.addEventListener('click', () => { const uid = tsUserIdInput.value.trim(); logTimestamp('End Break', null, uid); });
        if(btnEndCount) btnEndCount.addEventListener('click', () => logTimestamp('End'));
        if(btnTimeOut) btnTimeOut.addEventListener('click', () => logTimestamp('Time Out'));
        
        if(tsFilterUser) tsFilterUser.addEventListener('input', () => { tsCurrentPage = 1; renderTimestamps(); });
        if(tsShiftFilter) tsShiftFilter.addEventListener('change', () => { tsCurrentPage = 1; renderTimestamps(); });
        if(tsShowLongActive) tsShowLongActive.addEventListener('change', () => { tsCurrentPage = 1; renderTimestamps(); });
        if(tsAnalyticsDateFilter) tsAnalyticsDateFilter.addEventListener('change', () => { tsCurrentPage = 1; renderTimestamps(); });
        
        // Global Delete Functions
        window.deleteSession = function(ids) {
            if(!confirm('Permanently delete this session?')) return;
            const idArray = ids.split(',');
            let data = getTimestamps();
            data = data.filter(d => !idArray.includes(d.id));
            saveTimestamps(data);
            renderTimestamps();
            showToast('Session permanently deleted');
        };
        
        window.deleteBreak = function(startId, endId) {
            if(!confirm('Delete this break entry?')) return;
            let data = getTimestamps();
            const ids = [startId, endId].filter(x => x && x !== 'null' && x !== 'undefined');
            data = data.filter(d => !ids.includes(d.id));
            saveTimestamps(data);
            renderTimestamps();
            showToast('Break permanently deleted');
        };

        // Button Listeners
        if(tsDeleteSelectedBtn) {
            tsDeleteSelectedBtn.addEventListener('click', () => {
                if(!confirm('Permanently delete selected sessions?')) return;
                const checkboxes = document.querySelectorAll('.ts-row-checkbox:checked');
                let idsToDelete = [];
                checkboxes.forEach(cb => idsToDelete.push(...cb.dataset.ids.split(',')));
                let data = getTimestamps();
                data = data.filter(d => !idsToDelete.includes(d.id));
                saveTimestamps(data);
                renderTimestamps();
                showToast(`${checkboxes.length} sessions deleted`);
            });
        }
        
        if(tsPurgeAllBtn) {
            tsPurgeAllBtn.addEventListener('click', () => {
                if(!confirm('PERMANENTLY delete all currently shown logs? This cannot be undone.')) return;
                const allLogs = getTimestamps();
                // Simple purge: remove all logs that match current filters (re-using render logic would be complex, so we just clear all for now or filter by date)
                // For safety in this standalone, let's just filter by the selected date in analytics filter
                const date = tsAnalyticsDateFilter.value;
                const newData = allLogs.filter(d => !d.timestamp.startsWith(date));
                saveTimestamps(newData);
                renderTimestamps();
                showToast('Logs for selected date purged');
            });
        }

        if(tsExportBtn) {
            tsExportBtn.addEventListener('click', () => {
                const rows = [['User ID', 'Name', 'Area', 'Shift', 'Start', 'End', 'Duration']];
                const trs = document.querySelectorAll('#history-table tbody tr');
                trs.forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if(tds.length > 7) {
                        rows.push([
                            `"${tds[1].textContent}"`,
                            `"${tds[2].textContent}"`,
                            `"${tds[3].textContent}"`,
                            `"${tds[4].textContent}"`,
                            `"${tds[5].textContent}"`,
                            `"${tds[6].textContent}"`,
                            `"${tds[7].textContent}"`
                        ].join(','));
                    }
                });
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'counter_timestamps.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }

        if(breakDeleteSelectedBtn) {
            breakDeleteSelectedBtn.addEventListener('click', () => {
                if(!confirm('Permanently delete selected breaks?')) return;
                const checkboxes = document.querySelectorAll('.break-row-checkbox:checked');
                let idsToDelete = [];
                checkboxes.forEach(cb => idsToDelete.push(...cb.dataset.ids.split(',')));
                let data = getTimestamps();
                data = data.filter(d => !idsToDelete.includes(d.id));
                saveTimestamps(data);
                renderTimestamps();
                showToast(`${checkboxes.length} breaks deleted`);
            });
        }

        if(breakExportBtn) {
            breakExportBtn.addEventListener('click', () => {
                const rows = [['User', 'Name', 'Shift', 'Role', 'Break Out', 'Break In', 'Duration']];
                const trs = document.querySelectorAll('#break-log-table tbody tr');
                trs.forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if(tds.length > 7) {
                        rows.push([
                            `"${tds[1].textContent}"`,
                            `"${tds[2].textContent}"`,
                            `"${tds[3].textContent}"`,
                            `"${tds[4].textContent}"`,
                            `"${tds[5].textContent}"`,
                            `"${tds[6].textContent}"`,
                            `"${tds[7].textContent}"`
                        ].join(','));
                    }
                });
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'break_logs.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }
        
        if(document.getElementById('btn-break-delete-all')) {
            document.getElementById('btn-break-delete-all').addEventListener('click', () => {
                if(!confirm('Delete ALL displayed breaks?')) return;
                // For simplicity, just re-render to get IDs or filter data directly
                // Here we just reload page state to be safe or implement full filter logic
                alert('Please select breaks to delete using checkboxes for safety.');
            });
        }

        if(tsExportInactiveBtn) {
            tsExportInactiveBtn.addEventListener('click', () => {
                const rows = [['User ID', 'Name', 'Shift', 'Role', 'Last End Time', 'Status']];
                const trs = document.querySelectorAll('#inactive-users-table tbody tr');
                trs.forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if(tds.length > 5) {
                        rows.push([
                            `"${tds[0].textContent}"`,
                            `"${tds[1].textContent}"`,
                            `"${tds[2].textContent}"`,
                            `"${tds[3].textContent}"`,
                            `"${tds[4].textContent}"`,
                            `"${tds[5].textContent}"`
                        ].join(','));
                    }
                });
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'inactive_users.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }
        
        if(tsSelectAll) {
            tsSelectAll.addEventListener('change', (e) => {
                document.querySelectorAll('.ts-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateTsDeleteButton();
            });
        }
        
        if(breakSelectAll) {
            breakSelectAll.addEventListener('change', (e) => {
                document.querySelectorAll('.break-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateBreakDeleteButton();
            });
        }
        
        if(timestampTableBody) {
            timestampTableBody.addEventListener('change', (e) => { if(e.target.classList.contains('ts-row-checkbox')) updateTsDeleteButton(); });
        }
        
        const breakLogTable = document.getElementById('break-log-table');
        if(breakLogTable) {
            breakLogTable.addEventListener('change', (e) => { if(e.target.classList.contains('break-row-checkbox')) updateBreakDeleteButton(); });
        }
        
        if(breakShiftFilter) breakShiftFilter.addEventListener('change', () => renderTimestamps());
        if(breakShowActive) breakShowActive.addEventListener('change', () => renderTimestamps());

        if(tsUserIdInput) {
            tsUserIdInput.addEventListener('input', () => {
                const uid = tsUserIdInput.value.trim();
                const nameDisplay = document.getElementById('ts-user-name-display');
                if(nameDisplay) {
                    if(uid) {
                        const attData = getAttendanceData();
                        const userRecord = attData.find(a => a.userId === uid);
                        nameDisplay.value = userRecord ? `Name: ${userRecord.name} | Role: ${userRecord.role || '-'}` : '';
                    } else {
                        nameDisplay.value = '';
                    }
                }
            });
        }

        // Start Area Modal Logic
        document.querySelectorAll('#start-area-modal .area-card').forEach(card => {
            card.addEventListener('click', () => {
                selectedBinType = card.dataset.binType;
                startAreaModal.classList.add('hidden');
                const palletCard = document.querySelector('#warehouse-area-modal .area-card[data-warehouse-area="Pallet Picking"]');
                if(palletCard) palletCard.style.display = (selectedBinType === 'Reserved') ? 'none' : 'block';
                if(warehouseAreaModal) warehouseAreaModal.classList.remove('hidden');
                else logTimestamp('Start', selectedBinType);
            });
        });

        document.querySelectorAll('#warehouse-area-modal .area-card').forEach(card => {
            card.addEventListener('click', () => {
                const warehouseArea = card.dataset.warehouseArea;
                const finalArea = `${selectedBinType} - ${warehouseArea}`;
                warehouseAreaModal.classList.add('hidden');
                logTimestamp('Start', finalArea);
            });
        });
        
        if(cancelStartAreaBtn) cancelStartAreaBtn.addEventListener('click', () => startAreaModal.classList.add('hidden'));
        if(cancelWarehouseAreaBtn) cancelWarehouseAreaBtn.addEventListener('click', () => { warehouseAreaModal.classList.add('hidden'); startAreaModal.classList.remove('hidden'); });

        // End Count Modal Logic
        if (ecCancelBtn) ecCancelBtn.addEventListener('click', () => endCountModal.classList.add('hidden'));
        if (ecSaveBtn) {
            ecSaveBtn.addEventListener('click', () => {
                const userId = endCountModal.dataset.userId;
                const pallets = parseInt(document.getElementById('ec-pallets').value) || 0;
                const skus = parseInt(document.getElementById('ec-skus').value) || 0;
                const areaType = document.getElementById('ec-area-type').value;
                const now = new Date();

                if (areaType && areaType.startsWith('Reserved') && pallets === 0) { alert('Pallets Completed cannot be zero for Reserved area.'); return; }

                const data = getTimestamps();
                data.push({ id: Date.now().toString(), userId: userId, action: 'End', timestamp: now.toISOString(), areaType: areaType, pallets: pallets, skus: skus });
                saveTimestamps(data);
                renderTimestamps();

                // Dump to Hourly
                const shiftInfo = getShiftFromTimestamp(now);
                if (shiftInfo.date && shiftInfo.shift) {
                    const counters = getCountersData();
                    const entryIndex = counters.findIndex(c => c.date === shiftInfo.date && c.shift === shiftInfo.shift);
                    if (entryIndex > -1) {
                        const entry = counters[entryIndex];
                        const h = now.getHours();
                        const label = `${h}:00 - ${h+1}:00`;
                        if (!entry.hourlyActuals) entry.hourlyActuals = {};
                        if (!entry.hourlyPallets) entry.hourlyPallets = {};
                        entry.hourlyActuals[label] = (entry.hourlyActuals[label] || 0) + skus;
                        entry.hourlyPallets[label] = (entry.hourlyPallets[label] || 0) + pallets;
                        saveCountersData(counters);
                    }
                }

                showToast(`End Count recorded for ${userId}. Data saved.`);
                endCountModal.classList.add('hidden');
                tsUserIdInput.value = '';
                const nameDisplay = document.getElementById('ts-user-name-display');
                if(nameDisplay) nameDisplay.value = '';
                tsUserIdInput.focus();
            });
        }

        // Edit Time Modal
        if (cancelEditTimeBtn) cancelEditTimeBtn.addEventListener('click', () => editTimeModal.classList.add('hidden'));
        if (saveEditTimeBtn) {
            saveEditTimeBtn.addEventListener('click', () => {
                const logId = document.getElementById('edit-time-log-id').value;
                const newTimeValue = document.getElementById('edit-time-input').value;
                if (!logId || !newTimeValue) return;
                const newTimestamp = new Date(newTimeValue).toISOString();
                const data = getTimestamps();
                const logIndex = data.findIndex(d => d.id === logId);
                if (logIndex > -1) {
                    data[logIndex].timestamp = newTimestamp;
                    saveTimestamps(data);
                    renderTimestamps();
                    showToast('Timestamp updated successfully!');
                    editTimeModal.classList.add('hidden');
                }
            });
        }
        if (timestampTableBody) {
            // Listen on both tables for edit clicks
            const handleEditClick = (e) => {
                const target = e.target;
                if (target.classList.contains('editable-time')) {
                    const logId = target.dataset.logId;
                    const data = getTimestamps();
                    const log = data.find(d => d.id === logId);
                    if (log) {
                        document.getElementById('edit-time-log-id').value = logId;
                        const d = new Date(log.timestamp);
                        const localISO = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                        document.getElementById('edit-time-input').value = localISO;
                        editTimeModal.classList.remove('hidden');
                    }
                }
            };
            activeTableBody.addEventListener('click', handleEditClick);
            historyTableBody.addEventListener('click', handleEditClick);
        }

        // Toggle Section Logic
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.toggle-section-btn');
            if (btn) {
                const card = btn.closest('.card');
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Initial Render
        renderTimestamps();
        setTimeout(() => tsUserIdInput.focus(), 100);
    });

        // Tab Switching Logic
        window.openTab = function(evt, tabId) {
            const card = evt.target.closest('.card');
            const tabContents = card.querySelectorAll('.tab-content');
            tabContents.forEach(tc => tc.style.display = 'none');

            const tabBtns = card.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));

            const target = document.getElementById(tabId);
            if(target) target.style.display = 'flex';
            evt.target.classList.add('active');
        };
  </script>
</body>
</html>