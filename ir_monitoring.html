<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IR Monitoring - Inventory Management System</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #eef2f6; margin-bottom: 20px; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
    .btn-primary { background-color: #2752a7; color: white; }
    .btn-primary:hover { background-color: #1f4287; }
    
    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 50%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; }
    th { background-color: #f8f9fa; font-weight: 600; color: #444; }
    tr:hover { background-color: #f9f9f9; }
    
    .search-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
    
    .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px; }
    .pagination button { padding: 5px 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; }
    .pagination button:disabled { background: #eee; cursor: not-allowed; color: #999; }

    /* Icon Buttons */
    .icon-btn { padding: 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; color: #555; }
    .icon-btn:hover { background: #f0f0f0; }
    .icon-btn svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
    .icon-btn.btn-primary { background-color: #2752a7; color: white; border: 1px solid #2752a7; }
    .icon-btn.btn-primary:hover { background-color: #1f4287; }

    /* Flip Card Styles */
    .flip-card {
      background-color: transparent;
      perspective: 1000px;
      height: 300px;
    }
    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }
    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 8px;
      background-color: #fff;
    }
    .flip-card-back {
      transform: rotateY(180deg);
    }

    /* Main Card Flip Styles */
    .main-flip-container {
      perspective: 1000px;
      position: relative;
      min-height: 600px; /* Ensure enough height for absolute back face */
    }
    .main-flip-inner {
      transition: transform 0.8s;
      transform-style: preserve-3d;
      position: relative;
      width: 100%;
      height: 100%;
    }
    .main-flip-container.flipped .main-flip-inner {
      transform: rotateY(180deg);
    }
    .main-flip-front, .main-flip-back {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      width: 100%;
      top: 0;
      left: 0;
    }
    .main-flip-front {
      z-index: 2;
      transform: rotateY(0deg);
    }
    .main-flip-back {
      transform: rotateY(180deg);
      position: absolute;
      height: 100%;
      overflow-y: auto;
    }
    /* Dark Mode Header */
			body.dark-mode header {
				background: #1a252f;
				border-bottom: 1px solid #2c3e50;
			}
			body.dark-mode header h1 {
				color: #ecf0f1;
			}
  </style>
</head>
<body class="inventory-mode">
  <!-- Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button onclick="window.location.href='homepage.html'" data-tooltip="Homepage">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="menu-text">Homepage</span>
        </button>
      </li>
       <li><button  onclick="window.location.href='index.html'">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
              IAAF Monitoring</button></li>
						<li><button class="active" onclick="window.location.href='ir_monitoring.html'">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
              IR Monitoring</button></li>
      <li>
        <button data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu">
          <li><button onclick="window.location.href='cycle_count.html'">Cycle Count</button></li>
          <li><button onclick="window.location.href='cycle_count_reports.html'">Cycle Count Report</button></li>
          <li><button onclick="window.location.href='cycle_count_completion.html'">Cycle Count Completion</button></li>
          <li><button onclick="window.location.href='cycle_count_schedule.html'">Cycle Count Schedule</button></li>
        </ul>
      </li>
      <li><button onclick="window.location.href='settings.html'" data-tooltip="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <span class="menu-text">Settings</span>
      </button></li>
    </ul>
  </nav>

  <header>
    <h1>Incident Report Monitoring</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <!-- Optional back button or similar -->
      </div>
      <div class="nav-right">
        <div class="nav-notifications">
          <button class="notification-btn" title="Notifications">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <span class="notification-badge">0</span>
          </button>
          <div class="notification-menu">
            <div class="notification-header"><span>Notifications</span><button class="clear-notifications">Clear All</button></div>
            <ul class="notification-list"></ul>
          </div>
        </div>
        <div id="clock" class="clock" aria-live="polite"></div>
        <div class="nav-user" id="nav-user">
          <a href="profile.html" title="Profile" style="text-decoration:none; margin-right: 4px;"><span id="nav-avatar" class="avatar small"></span></a>
          <button class="user-btn" id="user-btn" aria-haspopup="true" aria-expanded="false"><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></button>
          <div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
            <a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
            <a href="settings.html" role="menuitem">Settings</a>
            <button id="logout-btn" role="menuitem">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="main-flip-container" id="main-flip-container">
      <div class="main-flip-inner">
        <!-- Front Face: Table & Controls -->
        <div class="main-flip-front card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>Incident Reports</h2>
        <div style="display:flex; gap:5px;">
          <button id="view-charts-btn" class="icon-btn" title="View Charts" style="background-color:#6f42c1; color:white;">
            <svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
          </button>
          <div style="width:1px; background:#ddd; margin:0 5px;"></div>
          <button id="delete-selected-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; display:none;">
            <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
          </button>
          <button id="mass-delete-btn" class="icon-btn" title="Mass Delete ALL" style="background-color:#d9534f; color:white;">
            <svg viewBox="0 0 24 24"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
          </button>
          <div style="width:1px; background:#ddd; margin:0 5px;"></div>
          <button id="export-csv-btn" class="icon-btn" title="Export CSV">
            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          </button>
          <button id="print-btn" class="icon-btn" title="Print Records">
            <svg viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
          </button>
          <button id="import-csv-btn" class="icon-btn" title="Import CSV">
            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          </button>
          <input type="file" id="import-csv-file" accept=".csv" style="display:none">
          <button id="download-template-btn" class="icon-btn" title="Download Template">
            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="9 15 12 12 15 15"></polyline></svg>
          </button>
          <button id="add-incident-btn" class="icon-btn btn-primary" title="Log New Incident">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          </button>
        </div>
      </div>

      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:15px; padding:15px; background:#f8f9fa; border-radius:6px; border:1px solid #eee;">
        <input type="text" id="search-input" class="search-box" style="flex:1 1 250px; margin-bottom:0;" placeholder="Multi-field search...">
        <select id="filter-role" class="search-box" style="flex:1 1 150px; margin-bottom:0;">
          <option value="">All Roles</option>
          <option value="Replen">Replen</option>
          <option value="Putaway">Putaway</option>
          <option value="IC">IC</option>
          <option value="Receving">Receving</option>
          <option value="RTV">RTV</option>
          <option value="Packer">Packer</option>
          <option value="Picker">Picker</option>
          <option value="CSR">CSR</option>
          <option value="Retriever">Retriever</option>
          <option value="Dispatch">Dispatch</option>
          <option value="Others">Others</option>
        </select>
        <select id="filter-status" class="search-box" style="flex:1 1 150px; margin-bottom:0;">
          <option value="">All Status</option>
          <option value="Open">Open</option>
          <option value="Closed">Closed</option>
        </select>
        <select id="ir-date-filter-type" class="search-box" style="flex: 1 1 150px; margin-bottom:0;"><option value="updated">Updated Date</option><option value="created">Created Date</option></select>
        <input type="date" id="ir-start-date" class="search-box" style="flex: 1 1 150px; margin-bottom:0;">
        <input type="date" id="ir-end-date" class="search-box" style="flex: 1 1 150px; margin-bottom:0;">
        <button id="ir-filter-date-btn" class="icon-btn" title="Filter Date Range"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg></button>
        <button id="ir-clear-date-filter-btn" class="icon-btn" title="Clear Date Filter"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
      </div>

      <div style="overflow-x:auto;">
        <table id="ir-table">
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="select-all"></th>
              <th class="sortable" data-sort="id" style="cursor:pointer">IR Control Number <span class="sort-icon"></span></th>
              <th class="sortable" data-sort="updatedDate" style="cursor:pointer">Updated Date <span class="sort-icon"></span></th>
              <th class="sortable" data-sort="createdDate" style="cursor:pointer">Created Date <span class="sort-icon"></span></th>
              <th class="sortable" data-sort="age" style="cursor:pointer">Age (days) <span class="sort-icon"></span></th>
              <th class="sortable" data-sort="role" style="cursor:pointer">Role <span class="sort-icon"></span></th>
              <th class="sortable" data-sort="person" style="cursor:pointer">Person Involved <span class="sort-icon"></span></th>
              <th class="sortable" data-sort="status" style="cursor:pointer">Status <span class="sort-icon"></span></th>
              <th class="sortable" data-sort="description" style="cursor:pointer">Description <span class="sort-icon"></span></th>
              <th>Attachment</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="pagination-controls" class="pagination"></div>
      <p id="no-data-msg" style="text-align:center; color:#666; margin-top:20px; display:none;">No incident reports found.</p>
    </div>

    <!-- Back Face: Charts -->
    <div class="main-flip-back card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>Analytics Dashboard</h2>
        <button id="view-table-btn" class="icon-btn" title="Back to Table" style="background-color:#6f42c1; color:white;">
          <svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </button>
      </div>
      
      <div style="display:flex; flex-wrap:wrap; gap:20px; margin-bottom:20px;">
        <div class="flip-card" style="flex:1; min-width:300px;">
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <button onclick="this.closest('.flip-card').classList.toggle('flipped')" style="position:absolute; top:10px; right:10px; z-index:10; cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;" title="Flip to Person View">↻</button>
              <div style="position:relative; height:100%; width:100%">
                <canvas id="chart-role"></canvas>
              </div>
            </div>
            <div class="flip-card-back">
              <button onclick="this.closest('.flip-card').classList.toggle('flipped')" style="position:absolute; top:10px; right:10px; z-index:10; cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;" title="Flip to Role View">↻</button>
              <div style="position:relative; height:100%; width:100%">
                <canvas id="chart-person"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="flip-card" style="flex:1; min-width:300px;">
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <button onclick="this.closest('.flip-card').classList.toggle('flipped')" style="position:absolute; top:10px; right:10px; z-index:10; cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;" title="Flip to Status View">↻</button>
              <div style="position:relative; height:100%; width:100%"><canvas id="chart-month"></canvas></div>
            </div>
            <div class="flip-card-back">
              <button onclick="this.closest('.flip-card').classList.toggle('flipped')" style="position:absolute; top:10px; right:10px; z-index:10; cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;" title="Flip to Trend View">↻</button>
              <div style="position:relative; height:100%; width:100%"><canvas id="chart-status"></canvas></div>
            </div>
          </div>
        </div>
        <div style="flex:1; min-width:300px; height:300px; border:1px solid #eee; padding:10px; border-radius:8px;">
            <canvas id="chart-description"></canvas>
        </div>
      </div>
    </div>
    </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="incident-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">Log Incident</h3>
      <form id="incident-form">
        <div class="form-group">
          <label for="ir-id">IR Control Number</label>
          <input type="text" id="ir-id" required placeholder="ECOM-YYYY-XXXX">
        </div>
        <div class="form-group">
          <label for="ir-role">Role</label>
          <select id="ir-role" required>
            <option value="">Select Role</option>
            <option value="Replen">Replen</option>
            <option value="Putaway">Putaway</option>
            <option value="IC">IC</option>
            <option value="Receving">Receving</option>
            <option value="RTV">RTV</option>
            <option value="Packer">Packer</option>
            <option value="Picker">Picker</option>
            <option value="CSR">CSR</option>
            <option value="Retriever">Retriever</option>
            <option value="Dispatch">Dispatch</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ir-person">Person Involved (Optional)</label>
          <input type="text" id="ir-person" placeholder="Name of person involved">
        </div>
        <div class="form-group">
          <label for="ir-status">Status</label>
          <select id="ir-status">
            <option value="Open">Open</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ir-desc">Description</label>
          <textarea id="ir-desc" rows="4" required placeholder="Describe the incident..."></textarea>
        </div>
        <div class="form-group">
          <label for="ir-attachment">Attachments (PDF/Picture)</label>
          <input type="file" id="ir-attachment" accept="image/*,application/pdf" multiple>
          <small style="color:#666;">Max size: 2MB (for demo purposes)</small>
        </div>
        <div style="text-align:right; margin-top:35px;">
            <button type="button" class="btn" style="background:#eee; color:#333; margin-right:10px;" id="cancel-btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Incident</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Print Options Modal -->
  <div id="print-options-modal" class="modal">
    <div class="modal-content" style="max-width: 300px; text-align: center;">
      <span class="close-print" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      <h3 style="margin-top:0;">Print Options</h3>
      <p>Choose which records to print:</p>
      <div style="display:flex; flex-direction: column; gap: 10px; margin-top: 15px;">
        <button id="print-filtered-btn" class="btn btn-primary">Print Filtered Records</button>
        <button id="print-all-btn" class="btn" style="background:#fff; color:#333; border:1px solid #ccc;">Print All Records</button>
        <button id="cancel-print-btn" class="btn" style="background:transparent; color:#666; border:none; margin-top: 5px;">Cancel</button>
      </div>
    </div>
  </div>

  <div id="toast-notification" class="toast"></div>
  <!-- Delete Confirmation Modal -->
  <div id="delete-confirm-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close-delete" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      <h3 style="margin-top:0;">Confirm Delete</h3>
      <p>You are about to delete <span id="delete-count" style="font-weight:bold; color:#d9534f">0</span> records.</p>
      <p style="color:#666; font-size:14px;">This action cannot be undone. Please enter Supervisor Code to proceed.</p>
      <div style="margin: 15px 0;">
        <label for="supervisor-code" style="display:block; margin-bottom:5px; font-weight:bold;">Supervisor Code</label>
        <input type="password" id="supervisor-code" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="Enter code">
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="cancel-delete-btn" class="btn" style="background:#eee; color:#333;">Cancel</button>
        <button id="confirm-delete-btn" class="btn" style="background:#d9534f; color:#fff;">Confirm Delete</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        if(!sessionStorage.getItem('dms_auth_v1')) {
            window.location.href = 'index.html';
            return;
        }
        
    const STORAGE_KEY_IR = 'ims_ir_records_v1';
    let irData = [];
    try {
        irData = JSON.parse(localStorage.getItem(STORAGE_KEY_IR) || '[]');
        if (!Array.isArray(irData)) irData = [];
    } catch(e) {
        console.error("Failed to parse IR data, resetting.", e);
        irData = [];
        localStorage.removeItem(STORAGE_KEY_IR);
    }
    let filteredData = [...irData];
    let currentPage = 1;
    const itemsPerPage = 5;
    let roleChartInstance = null;
    let monthChartInstance = null;
    let descChartInstance = null;
    let personChartInstance = null;
    let statusChartInstance = null;
    let deleteMode = 'selected';
    let sortField = null;
    let sortDirection = 'asc';
    const mainFlipContainer = document.getElementById('main-flip-container');
    const viewChartsBtn = document.getElementById('view-charts-btn');
    const viewTableBtn = document.getElementById('view-table-btn');

    const irDateFilterType = document.getElementById('ir-date-filter-type');
    const irStartDate = document.getElementById('ir-start-date');
    const irEndDate = document.getElementById('ir-end-date');
    const irFilterDateBtn = document.getElementById('ir-filter-date-btn');
    const irClearDateFilterBtn = document.getElementById('ir-clear-date-filter-btn');

    function parseCsvLine(line) {
        const values = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') { // Escaped quote
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                values.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        values.push(current);
        return values;
    }

    function getCandidateDates(dateStr) {
      if (!dateStr) return [];
      const candidates = [];
      
      // 1. Standard parse (handles ISO, MM/DD/YYYY, etc.)
      let s = dateStr;
      // Fix ISO UTC issue: treat YYYY-MM-DD as local
      if (typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s)) s += 'T00:00:00';
      
      const d1 = new Date(s);
      if (!isNaN(d1.getTime())) candidates.push(d1);

      // 2. Try parsing as DD/MM/YYYY explicitly if it contains slashes
      if (typeof dateStr === 'string' && dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
           // Assume YYYY is last or first. 
           let d, m, y;
           if (parts[2].length === 4) { 
             y = parseInt(parts[2], 10);
             // Try DD/MM/YYYY
             m = parseInt(parts[1], 10); d = parseInt(parts[0], 10);
             if (y && m && d) { const dt = new Date(y, m - 1, d); if (!isNaN(dt.getTime()) && dt.getDate() === d) candidates.push(dt); }
             // Try MM/DD/YYYY
             m = parseInt(parts[0], 10); d = parseInt(parts[1], 10);
             if (y && m && d) { const dt = new Date(y, m - 1, d); if (!isNaN(dt.getTime()) && dt.getDate() === d) candidates.push(dt); }
           }
           else if (parts[0].length === 4) { 
             y = parseInt(parts[0], 10); m = parseInt(parts[1], 10); d = parseInt(parts[2], 10); 
             if (y && m && d) {
               const d2 = new Date(y, m - 1, d); // Month is 0-indexed
               if (!isNaN(d2.getTime()) && d2.getDate() === d) candidates.push(d2);
             }
           }
        }
      }
      return candidates;
    }

    function normalizeDate(dateStr) {
      const candidates = getCandidateDates(dateStr);
      if (candidates.length > 0) return candidates[0].toISOString();
      return new Date().toISOString();
    }

    function renderTable() {
        const tbody = document.querySelector('#ir-table tbody');
        const noDataMsg = document.getElementById('no-data-msg');
        const paginationControls = document.getElementById('pagination-controls');
        tbody.innerHTML = '';
        
        const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        if (sortField) {
            filteredData.sort((a, b) => {
                let valA = a[sortField] || '';
                let valB = b[sortField] || '';
                if (sortField === 'updatedDate' || sortField === 'createdDate') {
                    valA = new Date(valA).getTime() || 0;
                    valB = new Date(valB).getTime() || 0;
                } else if (sortField === 'age') {
                    valA = Math.floor((new Date() - new Date(a.createdDate || a.date)) / (1000 * 60 * 60 * 24));
                    valB = Math.floor((new Date() - new Date(b.createdDate || b.date)) / (1000 * 60 * 60 * 24));
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        const pageData = filteredData.slice(start, end);
        
        if(filteredData.length === 0) {
            noDataMsg.style.display = 'block';
            paginationControls.style.display = 'none';
            if(document.getElementById('select-all')) document.getElementById('select-all').checked = false;
        } else {
            noDataMsg.style.display = 'none';
            paginationControls.style.display = 'flex';
            
            pageData.forEach((item, index) => {
                const tr = document.createElement('tr');
                let attachmentLinks = '<span style="color:#999">None</span>';
                
                // Normalize attachments to array
                let attachments = item.attachments || (item.attachment ? [item.attachment] : []);
                
                if(attachments.length > 0) {
                    attachmentLinks = attachments.map((att, i) => {
                        if(att.startsWith('data:')) {
                            const type = att.split(';')[0].split(':')[1];
                            const label = type.includes('pdf') ? 'PDF' : 'Img';
                            return `<a href="#" onclick="openAttachment('${item.id}', ${i}); return false;">${label} ${i+1}</a>`;
                        } else {
                            return `<a href="${att}" target="_blank">View</a>`;
                        }
                    }).join(', ');
                }

                const updatedDate = item.updatedDate ? new Date(item.updatedDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : 'N/A');
                const createdDate = item.createdDate ? new Date(item.createdDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : 'N/A');
                const age = Math.floor((new Date() - new Date(item.createdDate || item.date)) / (1000 * 60 * 60 * 24));

                tr.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" value="${item.id}"></td>
                    <td>${item.id}</td>
                    <td>${updatedDate}</td>
                    <td>${createdDate}</td>
                    <td>${age}</td>
                    <td>${item.role || ''}</td>
                    <td>${item.person || '-'}</td>
                    <td><span style="padding:2px 6px; border-radius:4px; font-size:12px; font-weight:bold; background:${item.status === 'Closed' ? '#e8f5e9' : '#fff3e0'}; color:${item.status === 'Closed' ? '#2ecc71' : '#f39c12'}">${item.status || 'Open'}</span></td>
                    <td>${item.description}</td>
                    <td>${attachmentLinks}</td>
                    <td style="white-space:nowrap;">
                        <button onclick="editIncident('${item.id}')" class="icon-btn" title="Edit" style="margin-right:5px;">
                            <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button onclick="deleteIncident('${item.id}')" class="icon-btn" title="Delete" style="color:#d9534f;">
                            <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Render Pagination Controls
        paginationControls.innerHTML = `
            <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
            <span>Page ${currentPage} of ${totalPages}</span>
            <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
        `;
        updateDeleteBtnState();
    }

    function summarizeMap(map, topN = 5){
        const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        if(entries.length <= topN) return map;
        const top = entries.slice(0, topN);
        const otherCount = entries.slice(topN).reduce((s,[_k,v]) => s+v, 0);
        const summarized = {};
        top.forEach(([k,v]) => { 
            // Truncate long descriptions for chart labels
            const label = k.length > 30 ? k.substring(0, 27) + '...' : k;
            summarized[label] = (summarized[label] || 0) + v; 
        });
        if(otherCount > 0) {
            summarized['Others'] = (summarized['Others'] || 0) + otherCount;
        }
        return summarized;
    }

    function updateCharts() {
        // Aggregate Role Data
        const roleCounts = {};
        irData.forEach(item => {
            const r = item.role || 'Unknown';
            roleCounts[r] = (roleCounts[r] || 0) + 1;
        });

        // Aggregate Month Data
        const monthCounts = {};
        irData.forEach(item => {
            const d = new Date(item.createdDate || item.date);
            if(!isNaN(d.getTime())) {
                const key = d.toISOString().slice(0, 7); // YYYY-MM
                monthCounts[key] = (monthCounts[key] || 0) + 1;
            }
        });
        
        const sortedMonths = Object.keys(monthCounts).sort();
        const monthLabels = sortedMonths.map(m => m);
        const monthData = sortedMonths.map(m => monthCounts[m]);

        // Render Role Chart
        const ctxRole = document.getElementById('chart-role');
        if(roleChartInstance) roleChartInstance.destroy();
        roleChartInstance = new Chart(ctxRole, {
            type: 'bar',
            data: {
                labels: Object.keys(roleCounts),
                datasets: [{
                    label: 'Incidents by Role',
                    data: Object.values(roleCounts),
                    backgroundColor: '#4e73df'
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { title: { display: true, text: 'Incidents by Role' } },
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const i = elements[0].index;
                        const label = roleChartInstance.data.labels[i];
                        const sel = document.getElementById('filter-role');
                        if(sel) { sel.value = label; applyFilter(); }
                    }
                }
            }
        });

        // Aggregate Person Data
        const personCounts = {};
        irData.forEach(item => {
            const p = (item.person || 'Unknown').trim();
            if(p) personCounts[p] = (personCounts[p] || 0) + 1;
        });
        const summarizedPerson = summarizeMap(personCounts, 5);

        // Render Person Chart
        const ctxPerson = document.getElementById('chart-person');
        if(personChartInstance) personChartInstance.destroy();
        personChartInstance = new Chart(ctxPerson, {
            type: 'bar',
            data: {
                labels: Object.keys(summarizedPerson),
                datasets: [{
                    label: 'Incidents by Person',
                    data: Object.values(summarizedPerson),
                    backgroundColor: '#e74a3b'
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { title: { display: true, text: 'Incidents by Person Involved' } },
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const i = elements[0].index;
                        const label = personChartInstance.data.labels[i];
                        if(label !== 'Others'){
                            const search = document.getElementById('search-input');
                            if(search) { search.value = label; applyFilter(); }
                        }
                    }
                }
            }
        });

        // Render Month Chart
        const ctxMonth = document.getElementById('chart-month');
        if(monthChartInstance) monthChartInstance.destroy();
        monthChartInstance = new Chart(ctxMonth, {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'Incidents per Month',
                    data: monthData,
                    borderColor: '#1cc88a',
                    tension: 0.1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Incidents Trend' } } }
        });

        // Aggregate Description Data
        const descCounts = {};
        irData.forEach(item => {
            const d = (item.description || 'N/A').trim();
            descCounts[d] = (descCounts[d] || 0) + 1;
        });
        const summarizedDesc = summarizeMap(descCounts, 5);

        // Render Description Chart
        const ctxDesc = document.getElementById('chart-description');
        if(descChartInstance) descChartInstance.destroy();
        descChartInstance = new Chart(ctxDesc, {
            type: 'bar',
            data: {
                labels: Object.keys(summarizedDesc),
                datasets: [{
                    label: 'Incidents by Description',
                    data: Object.values(summarizedDesc),
                    backgroundColor: '#fd7e14'
                }]
            },
            options: { 
                indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                plugins: { title: { display: true, text: 'Top Incident Descriptions' }, legend: { display: false } },
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const i = elements[0].index;
                        const label = descChartInstance.data.labels[i];
                        if(label !== 'Others'){
                            const search = document.getElementById('search-input');
                            if(search) { search.value = label; applyFilter(); }
                        }
                    }
                }
            }
        });

        // Render Status Chart
        const statusCounts = { 'Open': 0, 'Closed': 0 };
        irData.forEach(item => {
            const s = item.status || 'Open';
            statusCounts[s] = (statusCounts[s] || 0) + 1;
        });
        const ctxStatus = document.getElementById('chart-status');
        if(statusChartInstance) statusChartInstance.destroy();
        statusChartInstance = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: ['#f39c12', '#2ecc71']
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { title: { display: true, text: 'Status Overview' } },
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const i = elements[0].index;
                        const label = statusChartInstance.data.labels[i];
                        const sel = document.getElementById('filter-status');
                        if(sel) { sel.value = label; applyFilter(); }
                    }
                }
            }
        });
    }
    
    window.changePage = (delta) => {
        currentPage += delta;
        renderTable();
    };
    
    window.openAttachment = (id, index = 0) => {
        const item = irData.find(i => i.id === id);
        let attachments = item.attachments || (item.attachment ? [item.attachment] : []);
        const att = attachments[index];
        
        if(att) {
            const win = window.open();
            if(att.includes('application/pdf')) {
                 win.document.write('<iframe src="' + att + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
            } else {
                 win.document.write('<img src="' + att + '" style="max-width:100%">');
            }
        }
    };

    // Search
    function applyFilter() {
        const term = document.getElementById('search-input').value.toLowerCase();
        const roleFilter = document.getElementById('filter-role').value;
        const statusFilter = document.getElementById('filter-status').value;
        const terms = term.split(/\s+/).filter(t => t.length > 0);

        let dataToFilter = [...irData];

        // Date range filter
        let startDate = null;
        if (irStartDate.value) {
            const parts = irStartDate.value.split('-');
            startDate = new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0);
        }
        let endDate = null;
        if (irEndDate.value) {
            const parts = irEndDate.value.split('-');
            endDate = new Date(parts[0], parts[1] - 1, parts[2], 23, 59, 59, 999);
        }
        const filterType = irDateFilterType.value;

        if (startDate) {
            dataToFilter = dataToFilter.filter(item => {
                const dateStr = filterType === 'created' ? item.createdDate : item.updatedDate;
                if (!dateStr) return false;
                const dates = getCandidateDates(dateStr);
                return dates.some(d => d >= startDate);
            });
        }
        if (endDate) {
            dataToFilter = dataToFilter.filter(item => {
                const dateStr = filterType === 'created' ? item.createdDate : item.updatedDate;
                if (!dateStr) return false;
                const dates = getCandidateDates(dateStr);
                return dates.some(d => d <= endDate);
            });
        }
        
        filteredData = dataToFilter.filter(item => {
            const searchable = (item.id + ' ' + (item.role || '') + ' ' + (item.description || '') + ' ' + (item.person || '')).toLowerCase();
            const matchesSearch = terms.every(term => searchable.includes(term));
            const matchesRole = roleFilter === '' || (item.role === roleFilter);
            const matchesStatus = statusFilter === '' || (item.status || 'Open') === statusFilter;
            return matchesSearch && matchesRole && matchesStatus;
        });
        currentPage = 1;
        renderTable();
    }

    document.getElementById('search-input').addEventListener('input', applyFilter);
    document.getElementById('filter-role').addEventListener('change', applyFilter);
    document.getElementById('filter-status').addEventListener('change', applyFilter);

    if(irFilterDateBtn) irFilterDateBtn.addEventListener('click', applyFilter);
    if(irClearDateFilterBtn) {
        irClearDateFilterBtn.addEventListener('click', () => {
            irStartDate.value = '';
            irEndDate.value = '';
            applyFilter();
        });
    }

    document.getElementById('export-csv-btn').addEventListener('click', () => { // Updated
        const headers = ['IR Control Number', 'Updated Date', 'Created Date', 'Age (days)', 'Role', 'Person Involved', 'Status', 'Description'];
        const rows = filteredData.map(item => [
            `"${item.id}"`,
            `"${item.updatedDate ? new Date(item.updatedDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : '')}"`,
            `"${item.createdDate ? new Date(item.createdDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : '')}"`,
            `"${Math.floor((new Date() - new Date(item.createdDate || item.date)) / (1000 * 60 * 60 * 24))}"`,
            `"${item.role}"`,
            `"${item.person}"`,
            `"${item.status || 'Open'}"`,
            `"${(item.description || '').replace(/"/g, '""')}"`
        ]);
        const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'incident_reports.csv';
        link.click();
    });

    // Import / Download Template
    const importBtn = document.getElementById('import-csv-btn');
    const importFile = document.getElementById('import-csv-file');
    const downloadTemplateBtn = document.getElementById('download-template-btn');

    if(importBtn && importFile) {
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let csv = event.target.result;
                    // Remove BOM if present to avoid header mismatch
                    if (csv.charCodeAt(0) === 0xFEFF) {
                        csv = csv.slice(1);
                    }
                    const lines = csv.split(/\r\n|\n/);
                    if (lines.length === 0) return;
                    const headers = parseCsvLine(lines[0]).map(h => h.trim());
                    
                    const requiredHeaders = ['IR Control Number', 'Role', 'Description'];
                    if (!requiredHeaders.every(h => headers.includes(h))) {
                        const missing = requiredHeaders.filter(h => !headers.includes(h));
                        alert(`Import failed. Missing headers: ${missing.join(', ')}.\nFound: ${headers.join(', ')}`);
                        return;
                    }

                    let addedCount = 0;
                    let duplicateCount = 0;

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i]) continue;
                        const values = parseCsvLine(lines[i]);
                        
                        const createdDate = headers.includes('Created Date') ? normalizeDate(values[headers.indexOf('Created Date')]) : (headers.includes('Date') ? normalizeDate(values[headers.indexOf('Date')]) : new Date().toISOString());
                        const updatedDate = headers.includes('Updated Date') ? normalizeDate(values[headers.indexOf('Updated Date')]) : createdDate;
                        const newRecord = {
                            id: values[headers.indexOf('IR Control Number')],
                            createdDate: createdDate,
                            updatedDate: updatedDate,
                            role: values[headers.indexOf('Role')],
                            person: headers.includes('Person Involved') ? values[headers.indexOf('Person Involved')] : '',
                            status: headers.includes('Status') ? values[headers.indexOf('Status')] : 'Open',
                            description: values[headers.indexOf('Description')],
                            attachments: []
                        };

                        if (newRecord.id && newRecord.role && newRecord.description) {
                            if (irData.some(d => d.id === newRecord.id)) {
                                duplicateCount++;
                            } else {
                                irData.unshift(newRecord);
                                addedCount++;
                            }
                        }
                    }
                    if (addedCount > 0 || duplicateCount > 0) {
                        localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
                        let msg = `${addedCount} records imported.`;
                        if (duplicateCount > 0) msg += ` ${duplicateCount} duplicates skipped.`;
                        alert(msg);
                        applyFilter();
                        updateCharts();
                    } else {
                        alert('No valid new records found to import.');
                    }
                } catch (error) {
                    console.error("CSV Import Error:", error);
                    alert('Failed to import CSV. Check file format.');
                } finally {
                    importFile.value = '';
                }
            };
            reader.readAsText(file);
        });
    }

    if(downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', () => {
            const headers = ['IR Control Number', 'Created Date', 'Updated Date', 'Role', 'Person Involved', 'Status', 'Description'];
            const now = new Date().toLocaleString();
            const sample = ['ECOM-2024-0001', now, now, 'Picker', 'John Doe', 'Open', 'Picked wrong item'];
            const csvContent = headers.join(',') + '\n' + sample.map(s => `"${s}"`).join(',');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ir_template.csv';
            link.click();
        });
    }

    // Print Logic
    const printBtn = document.getElementById('print-btn');
    const printModal = document.getElementById('print-options-modal');
    const closePrintSpan = document.querySelector('.close-print');
    const printFilteredBtn = document.getElementById('print-filtered-btn');
    const printAllBtn = document.getElementById('print-all-btn');
    const cancelPrintBtn = document.getElementById('cancel-print-btn');

    if(printBtn && printModal) {
        printBtn.addEventListener('click', () => {
            printModal.style.display = 'block';
        });
        if(closePrintSpan) closePrintSpan.onclick = () => printModal.style.display = 'none';
        if(cancelPrintBtn) cancelPrintBtn.onclick = () => printModal.style.display = 'none';
    }

    function printData(data, title) {
        const printWindow = window.open('', '_blank');
        if(!printWindow) { alert('Please allow popups to print.'); return; }
        
        let html = `
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: sans-serif; font-size: 12px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
                th { background-color: #f0f0f0; }
                .header { text-align: center; margin-bottom: 20px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>${title}</h2>
                <p>Generated on: ${new Date().toLocaleString()}</p>
                <p>Total Records: ${data.length}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>IR Control Number</th>
                        <th>Updated Date</th>
                        <th>Created Date</th>
                        <th>Role</th>
                        <th>Person Involved</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        data.forEach(item => {
            html += `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.updatedDate ? new Date(item.updatedDate).toLocaleString() : ''}</td>
                    <td>${item.createdDate ? new Date(item.createdDate).toLocaleString() : ''}</td>
                    <td>${item.role || ''}</td>
                    <td>${item.person || ''}</td>
                    <td>${item.status || 'Open'}</td>
                    <td>${item.description || ''}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table><script>window.onload = function() { window.print(); window.close(); }<\/script></body></html>`;
        printWindow.document.write(html);
        printWindow.document.close();
    }

    if(printFilteredBtn) printFilteredBtn.onclick = () => { printData(filteredData, 'Incident Reports - Filtered'); printModal.style.display = 'none'; };
    if(printAllBtn) printAllBtn.onclick = () => { printData(irData, 'Incident Reports - All Records'); printModal.style.display = 'none'; };

    // Modal Logic
    const modal = document.getElementById('incident-modal');
    const btn = document.getElementById('add-incident-btn');
    const span = document.getElementsByClassName("close")[0];
    const deleteModal = document.getElementById('delete-confirm-modal');
    const closeDeleteSpan = document.querySelector('.close-delete');
    const cancelBtn = document.getElementById('cancel-btn');
    
    const closeModal = () => {
        modal.style.display = "none";
        document.getElementById('incident-form').reset();
        delete document.getElementById('incident-form').dataset.editingId;
    }
    const closeDeleteModal = () => {
        deleteModal.style.display = "none";
    }

    btn.onclick = () => {
        const year = new Date().getFullYear();
        const rand = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        document.getElementById('ir-id').value = `ECOM-${year}-${rand}`;
        modal.style.display = "block";
    };
    span.onclick = closeModal;
    if(closeDeleteSpan) closeDeleteSpan.onclick = closeDeleteModal;
    cancelBtn.onclick = closeModal;
    window.onclick = (event) => { 
        if (event.target == modal) closeModal(); 
        if (event.target == deleteModal) closeDeleteModal();
        if (event.target == printModal) printModal.style.display = 'none';
    }

    document.getElementById('incident-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('ir-id').value;
        const role = document.getElementById('ir-role').value;
        const person = document.getElementById('ir-person').value;
        const status = document.getElementById('ir-status').value;
        const desc = document.getElementById('ir-desc').value;
        const fileInput = document.getElementById('ir-attachment');
        const editingId = e.target.dataset.editingId;
        
        // Validation: Unique ID
        if (!editingId && irData.some(i => i.id === id)) {
            alert('IR Control Number must be unique.');
            return;
        }
        if (editingId && id !== editingId && irData.some(i => i.id === id)) {
             alert('IR Control Number must be unique.');
             return;
        }

        const processRecord = (newAttachments) => {
            let attachments = newAttachments;
            let msg = 'Incident report added successfully!';
            
            if (editingId) { // Editing existing record
                const index = irData.findIndex(i => i.id === editingId);
                if (index !== -1) {
                    msg = 'Incident report updated successfully!';
                    // If no new files, keep existing
                    if (!attachments || attachments.length === 0) {
                        attachments = irData[index].attachments || (irData[index].attachment ? [irData[index].attachment] : []);
                    }
                    const oldRecord = irData[index];
                    irData[index] = {
                        ...oldRecord,
                        id, role, person, status, description: desc, attachments,
                        createdDate: oldRecord.createdDate || oldRecord.date, // Preserve original creation date
                        updatedDate: new Date().toISOString()
                    };
                    delete irData[index].date; // Clean up old property
                }
            } else { // Creating new record
                const newRecord = {
                    id: id,
                    createdDate: new Date().toISOString(),
                    updatedDate: new Date().toISOString(),
                    role: role,
                    person: person,
                    status: status || 'Open',
                    description: desc,
                    attachments: attachments || []
                };
                irData.unshift(newRecord);
            }
            
            localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
            applyFilter();
            updateCharts();
            closeModal();
        };

        if(fileInput.files.length > 0) {
            const files = Array.from(fileInput.files);
            const promises = files.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve(ev.target.result);
                    reader.readAsDataURL(file);
                });
            });
            
            Promise.all(promises).then(results => {
                processRecord(results);
            });
        } else {
            processRecord([]);
        }
    });

    window.deleteIncident = (id) => {
        if(confirm('Delete this record?')) {
            irData = irData.filter(i => i.id !== id);
            localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
            applyFilter();
            updateCharts();
        }
    };

    window.editIncident = (id) => {
        const item = irData.find(i => i.id === id);
        if(item) {
            document.getElementById('ir-id').value = item.id;
            document.getElementById('ir-role').value = item.role || '';
            document.getElementById('ir-person').value = item.person || '';
            document.getElementById('ir-status').value = item.status || 'Open';
            document.getElementById('ir-desc').value = item.description;
            document.getElementById('incident-form').dataset.editingId = item.id;
            // Clear file input on edit
            document.getElementById('ir-attachment').value = '';
            modal.style.display = "block";
        }
    };

    // Mass Delete & Selection Logic
    const selectAll = document.getElementById('select-all');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const massDeleteBtn = document.getElementById('mass-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

    function updateDeleteBtnState() {
        const count = document.querySelectorAll('.row-checkbox:checked').length;
        if(deleteSelectedBtn) deleteSelectedBtn.style.display = count > 0 ? 'inline-flex' : 'none';
        if(selectAll) {
            const all = document.querySelectorAll('.row-checkbox');
            selectAll.checked = all.length > 0 && all.length === count;
        }
    }

    if(selectAll) {
        selectAll.addEventListener('change', () => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateDeleteBtnState();
        });
    }

    document.querySelector('#ir-table tbody').addEventListener('change', (e) => {
        if(e.target.classList.contains('row-checkbox')) updateDeleteBtnState();
    });

    if(deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', () => {
            const count = document.querySelectorAll('.row-checkbox:checked').length;
            if(count === 0) return;
            deleteMode = 'selected';
            document.getElementById('delete-count').textContent = count;
            document.getElementById('supervisor-code').value = '';
            deleteModal.style.display = 'block';
        });
    }

    if(massDeleteBtn) {
        massDeleteBtn.addEventListener('click', () => {
            if(irData.length === 0) return;
            deleteMode = 'all';
            document.getElementById('delete-count').textContent = 'ALL (' + irData.length + ')';
            document.getElementById('supervisor-code').value = '';
            deleteModal.style.display = 'block';
        });
    }

    if(cancelDeleteBtn) cancelDeleteBtn.onclick = closeDeleteModal;

    if(confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', () => {
            const code = document.getElementById('supervisor-code').value;
            if(code !== '12345' && code !== 'admin') {
                alert('Invalid Supervisor Code');
                return;
            }
            
            if(deleteMode === 'all') {
                irData = [];
            } else {
                const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
                irData = irData.filter(item => !selectedIds.includes(item.id));
            }
            
            localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
            applyFilter();
            updateCharts();
            closeDeleteModal();
            if(selectAll) selectAll.checked = false;
            updateDeleteBtnState();
        });
    }

    // Flip Logic
    if(viewChartsBtn) {
        viewChartsBtn.addEventListener('click', () => {
            mainFlipContainer.classList.add('flipped');
        });
    }
    if(viewTableBtn) {
        viewTableBtn.addEventListener('click', () => {
            mainFlipContainer.classList.remove('flipped');
        });
    }

    // Sort Logic
    document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const field = th.dataset.sort;
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '');
            const icon = th.querySelector('.sort-icon');
            if(icon) icon.textContent = sortDirection === 'asc' ? '↑' : '↓';
            renderTable();
        });
    });

    renderTable();
    updateCharts();
    });
  </script>
</body>
</html>