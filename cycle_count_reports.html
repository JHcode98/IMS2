<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cycle Count Reports - Inventory Management System</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .summary-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; border: 1px solid #eef2f6; }
    .summary-value { font-size: 2.5em; font-weight: bold; color: #2752a7; margin-bottom: 5px; }
    .summary-label { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
    .chart-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #eef2f6; height: 350px; position: relative; }
    .chart-container h3 { margin-top: 0; color: #333; font-size: 1.1em; margin-bottom: 15px; }
    /* Dark Mode Header */
			body.dark-mode header {
				background: #1a252f;
				border-bottom: 1px solid #2c3e50;
			}
			body.dark-mode header h1 {
				color: #ecf0f1;
			}
  </style>
</head>
<body class="inventory-mode">
  <!-- Main App Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button onclick="window.location.href='homepage.html'" data-tooltip="Homepage">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="menu-text">Homepage</span>
        </button>
      </li>
      <li>
        <button data-tooltip="Document Monitoring">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          <span class="menu-text">Document Monitoring</span>
        </button>
        <ul class="sidebar-submenu">
						<li><button onclick="window.location.href='index.html'">IAAF Monitoring</button></li>
						<li><button onclick="window.location.href='ir_monitoring.html'">IR Monitoring</button></li>
        </ul>
      </li>
      <li>
        <button data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu" style="display:block">
          <li><button onclick="window.location.href='cycle_count.html'">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.36-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.36 3.36L1 14"></path></svg>
							Cycle Count</button></li>
						<li><button class="active" onclick="window.location.href='cycle_count_reports.html'">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
							Cycle Count Report</button></li>
						<li><button onclick="window.location.href='cycle_count_completion.html'">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
							Cycle Count Completion</button></li>
						<li><button onclick="window.location.href='cycle_count_schedule.html'">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
							Cycle Count Schedule</button></li>
        </ul>
      </li>
      <li><button onclick="window.location.href='settings.html'" data-tooltip="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <span class="menu-text">Settings</span>
      </button></li>
    </ul>
  </nav>

  <header>
    <h1>Cycle Count Reports</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <button class="nav-btn" onclick="window.location.href='cycle_count.html'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:5px;vertical-align:text-bottom;"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          Back to Entry
        </button>
      </div>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </button>
      <div class="nav-right">
        <div class="nav-notifications">
          <button class="notification-btn" title="Notifications">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <span class="notification-badge">0</span>
          </button>
          <div class="notification-menu">
            <div class="notification-header"><span>Notifications</span><button class="clear-notifications">Clear All</button></div>
            <ul class="notification-list"></ul>
          </div>
        </div>
        <div id="clock" class="clock" aria-live="polite"></div>
        <div class="nav-user" id="nav-user">
          <a href="profile.html" title="Profile" style="text-decoration:none; margin-right: 4px;"><span id="nav-avatar" class="avatar small"></span></a>
          <button class="user-btn" id="user-btn" aria-haspopup="true" aria-expanded="false"><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></button>
          <div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
            <a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
            <a href="settings.html" role="menuitem">Settings</a>
            <button id="logout-btn" role="menuitem">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; padding: 15px;">
      <label for="report-start-date" style="font-weight:bold; color:#666;">From:</label>
      <input type="date" id="report-start-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <label for="report-end-date" style="font-weight:bold; color:#666;">To:</label>
      <input type="date" id="report-end-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <button id="apply-report-filter" style="padding:6px 12px;">Filter</button>
      <button id="clear-report-filter" style="padding:6px 12px; background: #fff; color: #333; border: 1px solid #ccc;">Clear</button>
    </div>
    <div class="report-grid">
      <div class="summary-card">
        <div class="summary-value" id="total-counts">0</div>
        <div class="summary-label">Total Counts</div>
      </div>
      <div class="summary-card">
        <div class="summary-value" id="accuracy-rate">0%</div>
        <div class="summary-label">Accuracy Rate</div>
      </div>
      <div class="summary-card">
        <div class="summary-value" id="net-variance">0</div>
        <div class="summary-label">Net Variance</div>
      </div>
      <div class="summary-card">
        <div class="summary-value" id="abs-variance">0</div>
        <div class="summary-label">Abs. Variance</div>
      </div>
    </div>

    <div class="report-grid">
      <div class="chart-container">
        <h3>Variance Distribution</h3>
        <canvas id="variance-chart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Daily Count Volume</h3>
        <canvas id="daily-chart"></canvas>
      </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';
    
    // Load Data and Render Reports
    const STORAGE_KEY_CC = 'ims_cycle_count_v1';
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
    let varianceChartInstance = null;
    let dailyChartInstance = null;

    function getCandidateDates(dateStr) {
      if (!dateStr) return [];
      const candidates = [];
      
      // 1. Standard parse (handles ISO, MM/DD/YYYY, etc.)
      let s = dateStr;
      // Fix ISO UTC issue: treat YYYY-MM-DD as local
      if (typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s)) s += 'T00:00:00';
      
      const d1 = new Date(s);
      if (!isNaN(d1.getTime())) candidates.push(d1);

      // 2. Try parsing as DD/MM/YYYY explicitly if it contains slashes
      if (typeof dateStr === 'string' && dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
           // Assume YYYY is last or first. 
           let d, m, y;
           if (parts[2].length === 4) { 
             y = parseInt(parts[2], 10);
             // Try DD/MM/YYYY
             m = parseInt(parts[1], 10); d = parseInt(parts[0], 10);
             if (y && m && d) { const dt = new Date(y, m - 1, d); if (!isNaN(dt.getTime()) && dt.getDate() === d) candidates.push(dt); }
             // Try MM/DD/YYYY
             m = parseInt(parts[0], 10); d = parseInt(parts[1], 10);
             if (y && m && d) { const dt = new Date(y, m - 1, d); if (!isNaN(dt.getTime()) && dt.getDate() === d) candidates.push(dt); }
           }
           else if (parts[0].length === 4) { 
             y = parseInt(parts[0], 10); m = parseInt(parts[1], 10); d = parseInt(parts[2], 10); 
             if (y && m && d) {
               const d2 = new Date(y, m - 1, d); // Month is 0-indexed
               if (!isNaN(d2.getTime()) && d2.getDate() === d) candidates.push(d2);
             }
           }
        }
      }
      return candidates;
    }

    function renderReports(reportData) {
        // 1. Summary Metrics
        const totalCounts = reportData.length;
        let accurateCounts = 0;
        let netVariance = 0;
        let absVariance = 0;

        reportData.forEach(item => {
            const diff = (item.physical || 0) - (item.system || 0);
            if (diff === 0) accurateCounts++;
            netVariance += diff;
            absVariance += Math.abs(diff);
        });

        const accuracyRate = totalCounts > 0 ? ((accurateCounts / totalCounts) * 100).toFixed(1) : 0;

        document.getElementById('total-counts').textContent = totalCounts;
        document.getElementById('accuracy-rate').textContent = accuracyRate + '%';
        document.getElementById('net-variance').textContent = (netVariance > 0 ? '+' : '') + netVariance;
        document.getElementById('abs-variance').textContent = absVariance;

        // 2. Variance Chart (Pie)
        let exact = 0, surplus = 0, shortage = 0;
        reportData.forEach(item => {
            const diff = (item.physical || 0) - (item.system || 0);
            if (diff === 0) exact++;
            else if (diff > 0) surplus++;
            else shortage++;
        });

        const ctxVariance = document.getElementById('variance-chart').getContext('2d');
        if (varianceChartInstance) varianceChartInstance.destroy();
        varianceChartInstance = new Chart(ctxVariance, {
            type: 'doughnut',
            data: {
                labels: ['Exact Match', 'Surplus', 'Shortage'],
                datasets: [{
                    data: [exact, surplus, shortage],
                    backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // 3. Daily Volume Chart (Bar)
        const countsByDate = {};
        reportData.forEach(item => {
            const dStr = item.createdDate || item.date;
            if(!dStr) return;
            const dateKey = new Date(dStr).toLocaleDateString();
            countsByDate[dateKey] = (countsByDate[dateKey] || 0) + 1;
        });

        const sortedDates = Object.keys(countsByDate).sort((a,b) => new Date(a) - new Date(b));
        
        const ctxDaily = document.getElementById('daily-chart').getContext('2d');
        if (dailyChartInstance) dailyChartInstance.destroy();
        dailyChartInstance = new Chart(ctxDaily, {
            type: 'bar',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'Items Counted',
                    data: sortedDates.map(d => countsByDate[d]),
                    backgroundColor: '#3498db',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                }
            }
        });
    }

    renderReports(data);

    document.getElementById('apply-report-filter').addEventListener('click', () => {
        const startVal = document.getElementById('report-start-date').value;
        const endVal = document.getElementById('report-end-date').value;
        
        let filtered = data;
        
        let startDate = null;
        if (startVal) {
            const parts = startVal.split('-');
            startDate = new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0);
        }
        
        let endDate = null;
        if (endVal) {
            const parts = endVal.split('-');
            endDate = new Date(parts[0], parts[1] - 1, parts[2], 23, 59, 59, 999);
        }
        
        if (startDate) {
            filtered = filtered.filter(item => {
                const dateStr = item.createdDate || item.date;
                const dates = getCandidateDates(dateStr);
                return dates.some(d => d >= startDate);
            });
        }
        
        if (endDate) {
            filtered = filtered.filter(item => {
                const dateStr = item.createdDate || item.date;
                const dates = getCandidateDates(dateStr);
                return dates.some(d => d <= endDate);
            });
        }
        
        renderReports(filtered);
    });

    document.getElementById('clear-report-filter').addEventListener('click', () => {
        document.getElementById('report-start-date').value = '';
        document.getElementById('report-end-date').value = '';
        renderReports(data);
    });
  </script>
</body>
</html>